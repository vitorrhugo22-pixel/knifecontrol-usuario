<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KnifeControl Usu√°rio ‚Äî Fallback Google Forms</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2NkYGD4DwAB4gF/2cPq7QAAAABJRU5ErkJggg=="/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; margin:0; padding:0; }
    .fade-in { animation: fadeIn .25s ease-in; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:translateY(0)} }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-3xl mx-auto px-4 py-3">
      <h1 class="text-xl md:text-2xl font-bold text-gray-800">üî™ KnifeControl ‚Äî Modo Fallback (Google Forms)</h1>
      <p class="text-xs text-green-700 mt-1">‚úÖ Conectado ‚Äî registros ser√£o enviados ao Google Forms</p>
    </div>
  </div>

  <!-- App Container -->
  <div class="max-w-3xl mx-auto p-4">

    <!-- LOGIN -->
    <section id="loginScreen" class="fade-in">
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Entrar</h2>

        <div class="grid gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
            <select id="setorSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Carregando setores...</option>
            </select>
          </div>

          <button id="btnEntrar" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
            Entrar
          </button>
        </div>
      </div>
    </section>

    <!-- MENU -->
    <section id="mainMenu" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold text-gray-800">Bem-vindo</h2>
            <p id="setorAtual" class="text-gray-600 mt-1">Setor: ‚Äî</p>
          </div>
          <button id="btnSair" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg">Sair</button>
        </div>
      </div>

      <div class="grid gap-4">
        <button onclick="showScreen('retiradaScreen')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition">
          <div class="text-4xl mb-1">üì§</div>
          <div class="text-lg font-bold">Retirada de Objeto</div>
          <div class="text-sm opacity-90">Registrar retirada (marca como <b>Em Uso</b>)</div>
        </button>

        <button onclick="showScreen('devolucaoScreen')" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition">
          <div class="text-4xl mb-1">üì•</div>
          <div class="text-lg font-bold">Devolu√ß√£o de Objeto</div>
          <div class="text-sm opacity-90">Registrar devolu√ß√£o (marca como <b>Devolvido</b>)</div>
        </button>

        <button onclick="showScreen('inventarioScreen')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition">
          <div class="text-4xl mb-1">üìã</div>
          <div class="text-lg font-bold">Invent√°rio de Fim de Turno</div>
          <div class="text-sm opacity-90">Enviar status (<b>Devolvido</b>/<b>Em Uso</b>) de todos os objetos do setor</div>
        </button>
      </div>
    </section>

    <!-- RETIRADA -->
    <section id="retiradaScreen" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">üì§</span>Retirada de Objeto</h2>

        <!-- Identifica√ß√£o -->
        <div class="grid gap-3 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Matr√≠cula</label>
            <input id="matriculaRetirada" type="text" inputmode="numeric" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Digite a matr√≠cula"/>
            <button onclick="identificarPorMatricula('retirada')" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Identificar</button>
          </div>

          <div id="boxFuncionarioRetirada" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-3">
            <div class="grid gap-1">
              <div><strong>üìã Matr√≠cula:</strong> <span id="matriculaLabelRetirada">‚Äî</span></div>
              <div><strong>üë§ Nome:</strong> <input id="nomeFuncionarioRetirada" class="px-2 py-1 border border-green-300 rounded-md bg-gray-100 text-gray-700" readonly /></div>
              <div><strong>üè¢ Setor:</strong> <span id="setorFuncionarioRetirada">‚Äî</span></div>
              <div><strong>üïê Leitura:</strong> <span id="leituraRetirada">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Objeto -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Selecione o Objeto</label>
          <select id="objetoRetirada" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione...</option>
          </select>
        </div>

        <button onclick="confirmarRetirada()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">Confirmar Retirada</button>
        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mt-3">‚Üê Voltar ao Menu</button>
      </div>
    </section>

    <!-- DEVOLU√á√ÉO -->
    <section id="devolucaoScreen" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">üì•</span>Devolu√ß√£o de Objeto</h2>

        <!-- (Opcional) Identifica√ß√£o s√≥ para registrar quem devolveu ‚Äî N√ÉO obrigat√≥ria -->
        <div class="grid gap-3 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Matr√≠cula (opcional)</label>
            <input id="matriculaDevolucao" type="text" inputmode="numeric" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Se quiser registrar"/>
            <button onclick="identificarPorMatricula('devolucao')" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Identificar</button>
          </div>

          <div id="boxFuncionarioDevolucao" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-3">
            <div class="grid gap-1">
              <div><strong>üìã Matr√≠cula:</strong> <span id="matriculaLabelDevolucao">‚Äî</span></div>
              <div><strong>üë§ Nome:</strong> <input id="nomeFuncionarioDevolucao" class="px-2 py-1 border border-green-300 rounded-md bg-gray-100 text-gray-700" readonly /></div>
              <div><strong>üè¢ Setor:</strong> <span id="setorFuncionarioDevolucao">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Objeto -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Selecione o Objeto</label>
          <select id="objetoDevolucao" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione...</option>
          </select>
        </div>

        <button onclick="confirmarDevolucao()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">Confirmar Devolu√ß√£o</button>
        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mt-3">‚Üê Voltar ao Menu</button>
      </div>
    </section>

    <!-- INVENT√ÅRIO -->
    <section id="inventarioScreen" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">üìã</span>Invent√°rio de Fim de Turno</h2>

        <!-- Identifica√ß√£o -->
        <div class="grid gap-3 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Matr√≠cula</label>
            <input id="matriculaInventario" type="text" inputmode="numeric" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Digite a matr√≠cula"/>
            <button onclick="identificarPorMatricula('inventario')" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Identificar</button>
          </div>

          <div id="boxFuncionarioInventario" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-3">
            <div class="grid gap-1">
              <div><strong>üìã Matr√≠cula:</strong> <span id="matriculaLabelInventario">‚Äî</span></div>
              <div><strong>üë§ Nome:</strong> <input id="nomeFuncionarioInventario" class="px-2 py-1 border border-green-300 rounded-md bg-gray-100 text-gray-700" readonly /></div>
              <div><strong>üè¢ Setor:</strong> <span id="setorFuncionarioInventario">‚Äî</span></div>
              <div><strong>üïê Leitura:</strong> <span id="leituraInventario">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Lista de objetos com status -->
        <div id="statusObjetosInventario" class="hidden mb-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Status dos Objetos do Setor</h3>
          <div id="listaObjetosInventario" class="space-y-2"></div>
        </div>

        <div id="inventarioActions" class="hidden">
          <button id="btnFinalizarInventario" onclick="finalizarInventario()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed">Finalizar Invent√°rio</button>
        </div>

        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mt-3">‚Üê Voltar ao Menu</button>
      </div>
    </section>

  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed top-20 right-4 z-50 max-w-sm">
    <div id="toastContent" class="rounded-xl shadow-2xl p-4 transform transition-all"></div>
  </div>

  <script>
  // ====================== CONFIG FORMS (UMA pergunta "Detalhes Extras") ======================
  // URL do seu Form (endpoint /formResponse)
  const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScKBnRZ2StGX5qIqGVPrsXbt-hTbTawDYWqR3iEELCq9of7Xw/formResponse';

  // Mapeamento de campos => entry.*
  // IMPORTANTE: "status" usa o MESMO entry da pergunta "Detalhes Extras" (checkbox √∫nico com 2 op√ß√µes)
  const FORMS_FIELDS = {
    objeto:      'entry.587663124',
    matricula:   'entry.360956002',
    funcionario: 'entry.245251034',
    setor:       'entry.431322508',
    timestamp:   'entry.2072805918',
    status:      'entry.1169418597' // "Detalhes Extras" ‚Äî op√ß√µes "Em Uso" / "Devolvido"
  };

  // Os r√≥tulos DEVEM ser id√™nticos aos do Forms
  const STATUS_LABELS = { emUso: 'Em Uso', devolvido: 'Devolvido' };

  // ====================== ESTADO ======================
  let DATA = {
    setores: [],                 // ['Seguran√ßa', 'A√ßougue', ...]
    funcionarios: [],            // [{ matricula, nome, setor }]
    objetosPorSetor: {}          // { 'Seguran√ßa': ['Faca 01', 'Tesoura 02'] }
  };
  let currentSetor = '';
  let currentFuncionario = null; // { id, nome, setor, ts }

  // ====================== TOAST ======================
  function showToast(message, type='success') {
    const toast = document.getElementById('toast');
    const toastContent = document.getElementById('toastContent');
    const bg = type === 'success' ? 'bg-green-600' : 'bg-red-600';
    const icon = type === 'success' ? '‚úÖ' : '‚ùå';
    toastContent.className = `rounded-xl shadow-2xl p-4 text-white ${bg}`;
    toastContent.innerHTML = `<div class="flex items-center space-x-3"><div class="text-2xl">${icon}</div><div class="flex-1 font-semibold">${message}</div></div>`;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
  }

  // ====================== AUX ======================
  function showScreen(id) {
    ['loginScreen','mainMenu','retiradaScreen','devolucaoScreen','inventarioScreen']
      .forEach(s => document.getElementById(s).classList.add('hidden'));
    const el = document.getElementById(id);
    el.classList.remove('hidden');
    el.classList.add('fade-in');

    if (id === 'retiradaScreen') {
      preencherDropdownObjetos('objetoRetirada');
      resetIdentificacao('retirada');
    }
    if (id === 'devolucaoScreen') {
      preencherDropdownObjetos('objetoDevolucao');
      resetIdentificacao('devolucao');
    }
    if (id === 'inventarioScreen') {
      resetIdentificacao('inventario');
      prepararInventario();
    }
  }

  function resetIdentificacao(ctx) {
    if (ctx === 'retirada') {
      document.getElementById('matriculaRetirada').value = '';
      document.getElementById('boxFuncionarioRetirada').classList.add('hidden');
      currentFuncionario = null;
    }
    if (ctx === 'devolucao') {
      document.getElementById('matriculaDevolucao').value = '';
      document.getElementById('boxFuncionarioDevolucao').classList.add('hidden');
    }
    if (ctx === 'inventario') {
      document.getElementById('matriculaInventario').value = '';
      document.getElementById('boxFuncionarioInventario').classList.add('hidden');
      currentFuncionario = null;
    }
  }

  function logout() {
    currentSetor = '';
    currentFuncionario = null;
    document.getElementById('setorSelect').value = '';
    showScreen('loginScreen');
  }

  // ====================== CARREGAR planilha.json ======================
  async function loadData() {
    try {
      const res = await fetch('./planilha.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('Falha ao carregar planilha.json');
      const raw = await res.json();

      // Normaliza√ß√£o leve de chaves
      const setKey = (obj, keys) => {
        for (const k of keys) if (obj[k] !== undefined) return obj[k];
        return undefined;
      };

      // Setores
      const setores = Array.isArray(raw.Setores || raw.setores) ? (raw.Setores || raw.setores) : [];
      DATA.setores = setores.map(s => String(s).trim()).filter(Boolean);

      // Funcionarios
      const arrFunc = Array.isArray(raw.Funcionarios || raw.funcionarios) ? (raw.Funcionarios || raw.funcionarios) : [];
      DATA.funcionarios = arrFunc.map(f => {
        return {
          matricula: String(setKey(f, ['Matricula','matricula','id','ID']) || '').trim(),
          nome: String(setKey(f, ['Nome','nome']) || '').trim(),
          setor: String(setKey(f, ['Setor','setor']) || '').trim()
        };
      }).filter(f => f.matricula);

      // Objetos por Setor
      const ops = raw.ObjetosPorSetor || raw.objetosPorSetor || {};
      const norm = {};
      for (const k of Object.keys(ops)) {
        const arr = Array.isArray(ops[k]) ? ops[k] : [];
        norm[String(k).trim()] = arr.map(x => String(x).trim()).filter(Boolean);
      }
      DATA.objetosPorSetor = norm;

      // Popular dropdown de Setor (prioriza os setores presentes em ObjetosPorSetor; se vazio, usa Setores)
      const setoresFonte = Object.keys(DATA.objetosPorSetor).length ? Object.keys(DATA.objetosPorSetor) : DATA.setores;
      const setorSelect = document.getElementById('setorSelect');
      setorSelect.innerHTML = '<option value="">Selecione um setor...</option>';
      setoresFonte.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        setorSelect.appendChild(opt);
      });
    } catch (err) {
      console.error(err);
      showToast('Falha ao carregar planilha.json', 'error');
      // fallback m√≠nimo
      DATA.setores = ['Teste'];
      DATA.objetosPorSetor = { 'Teste': ['FACA TESTE'] };
      DATA.funcionarios = [];
      const setorSelect = document.getElementById('setorSelect');
      setorSelect.innerHTML = '<option value="">Selecione um setor...</option><option>Teste</option>';
    }
  }

  // ====================== IDENTIFICA√á√ÉO POR MATR√çCULA ======================
  function buscarFuncionarioPorMatricula(matricula, setorAlvo) {
    const mat = String(matricula || '').trim();
    if (!mat) return null;
    // Tenta por setor atual primeiro
    let found = DATA.funcionarios.find(f => f.matricula === mat && (!!setorAlvo ? f.setor === setorAlvo : true));
    if (!found) {
      // fallback: qualquer setor
      found = DATA.funcionarios.find(f => f.matricula === mat);
    }
    return found || null;
  }

  function identificarPorMatricula(context) {
    const now = new Date();
    if (context === 'retirada') {
      const mat = document.getElementById('matriculaRetirada').value;
      const f = buscarFuncionarioPorMatricula(mat, currentSetor);
      if (!f) { showToast('Matr√≠cula n√£o encontrada no setor/planilha', 'error'); return; }
      currentFuncionario = { id: f.matricula, nome: f.nome, setor: f.setor || currentSetor, ts: now };
      document.getElementById('boxFuncionarioRetirada').classList.remove('hidden');
      document.getElementById('matriculaLabelRetirada').textContent = f.matricula;
      document.getElementById('nomeFuncionarioRetirada').value = f.nome || '';
      document.getElementById('setorFuncionarioRetirada').textContent = f.setor || currentSetor;
      document.getElementById('leituraRetirada').textContent = now.toLocaleString('pt-BR');
      showToast('Funcion√°rio identificado', 'success');
    }

    if (context === 'devolucao') {
      const mat = document.getElementById('matriculaDevolucao').value;
      if (!mat) { // matr√≠cula √© opcional
        document.getElementById('boxFuncionarioDevolucao').classList.add('hidden');
        showToast('Devolu√ß√£o sem matr√≠cula (opcional)', 'success');
        return;
      }
      const f = buscarFuncionarioPorMatricula(mat, currentSetor);
      if (!f) { showToast('Matr√≠cula n√£o encontrada no setor/planilha', 'error'); return; }
      document.getElementById('boxFuncionarioDevolucao').classList.remove('hidden');
      document.getElementById('matriculaLabelDevolucao').textContent = f.matricula;
      document.getElementById('nomeFuncionarioDevolucao').value = f.nome || '';
      document.getElementById('setorFuncionarioDevolucao').textContent = f.setor || currentSetor;
      showToast('Funcion√°rio identificado (opcional)', 'success');
    }

    if (context === 'inventario') {
      const mat = document.getElementById('matriculaInventario').value;
      const f = buscarFuncionarioPorMatricula(mat, currentSetor);
      if (!f) { showToast('Matr√≠cula n√£o encontrada no setor/planilha', 'error'); return; }
      currentFuncionario = { id: f.matricula, nome: f.nome, setor: f.setor || currentSetor, ts: now };
      document.getElementById('boxFuncionarioInventario').classList.remove('hidden');
      document.getElementById('matriculaLabelInventario').textContent = f.matricula;
      document.getElementById('nomeFuncionarioInventario').value = f.nome || '';
      document.getElementById('setorFuncionarioInventario').textContent = f.setor || currentSetor;
      document.getElementById('leituraInventario').textContent = now.toLocaleString('pt-BR');
      // Ao identificar, prepara a lista
      prepararInventario();
      showToast('Funcion√°rio identificado', 'success');
    }
  }

  // ====================== UI OBJETOS ======================
  function preencherDropdownObjetos(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Selecione...</option>';
    const lista = DATA.objetosPorSetor[currentSetor] || [];
    if (lista.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Nenhum objeto configurado para este setor';
      select.appendChild(opt);
      select.disabled = true;
      return;
    }
    select.disabled = false;
    lista.forEach(nome => {
      const o = document.createElement('option');
      o.value = nome;
      o.textContent = nome;
      select.appendChild(o);
    });
  }

  function prepararInventario() {
    const container = document.getElementById('listaObjetosInventario');
    const statusDiv = document.getElementById('statusObjetosInventario');
    const actionsDiv = document.getElementById('inventarioActions');
    container.innerHTML = '';

    const lista = DATA.objetosPorSetor[currentSetor] || [];
    if (lista.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum objeto configurado para este setor no arquivo <span class="font-mono">planilha.json</span>.</p>';
      statusDiv.classList.remove('hidden');
      actionsDiv.classList.add('hidden');
      return;
    }

    statusDiv.classList.remove('hidden');
    actionsDiv.classList.remove('hidden');

    lista.forEach((nome, idx) => {
      const id = 'inv_' + idx;
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg';
      row.innerHTML = `
        <div class="font-semibold text-gray-800">${nome}</div>
        <div class="flex items-center space-x-4">
          <label class="inline-flex items-center space-x-1 text-sm">
            <input type="radio" name="${id}" value="${STATUS_LABELS.devolvido}" checked class="text-purple-600"/>
            <span>Devolvido</span>
          </label>
          <label class="inline-flex items-center space-x-1 text-sm">
            <input type="radio" name="${id}" value="${STATUS_LABELS.emUso}" class="text-purple-600"/>
            <span>Em Uso</span>
          </label>
        </div>
      `;
      row.dataset.objeto = nome;
      row.dataset.group = id;
      container.appendChild(row);
    });
  }

  // ====================== ENVIO AO GOOGLE FORMS ======================
  // Envio mais compat√≠vel: application/x-www-form-urlencoded + no-cors
  async function postToForms({ objeto, matricula, funcionario, setor, status }) {
    if (!GOOGLE_FORM_URL.includes('/formResponse')) throw new Error('GOOGLE_FORM_URL inv√°lida');
    const params = new URLSearchParams();
    params.append('fvv', '1');
    params.append('pageHistory', '0');

    params.append(FORMS_FIELDS.objeto, (objeto || '').trim());
    params.append(FORMS_FIELDS.matricula, (matricula || '').trim());
    params.append(FORMS_FIELDS.funcionario, (funcionario || '').trim());
    params.append(FORMS_FIELDS.setor, (setor || '').trim());
    params.append(FORMS_FIELDS.timestamp, new Date().toISOString());
    params.append(FORMS_FIELDS.status, status); // "Em Uso" OU "Devolvido"

    await fetch(GOOGLE_FORM_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: params.toString()
    });
  }

  // ====================== A√á√ïES: RETIRADA / DEVOLU√á√ÉO / INVENT√ÅRIO ======================
  function confirmarRetirada() {
    const objeto = (document.getElementById('objetoRetirada').value || '').trim();
    if (!objeto) { showToast('Selecione o objeto', 'error'); return; }
    if (!currentFuncionario) { showToast('Identifique o funcion√°rio pela matr√≠cula', 'error'); return; }

    const nome = document.getElementById('nomeFuncionarioRetirada').value || '';
    const status = STATUS_LABELS.emUso;

    if (!confirm(`Confirma a retirada do objeto "${objeto}"?`)) return;

    postToForms({
      objeto,
      matricula: currentFuncionario.id,
      funcionario: nome,
      setor: currentSetor,
      status
    }).then(() => {
      showToast('Retirada registrada com sucesso!', 'success');
      showScreen('mainMenu');
    }).catch(err => {
      showToast('Falha ao enviar ao Forms: ' + err.message, 'error');
    });
  }

  function confirmarDevolucao() {
    const objeto = (document.getElementById('objetoDevolucao').value || '').trim();
    if (!objeto) { showToast('Selecione o objeto', 'error'); return; }

    // matr√≠cula opcional
    const mat = (document.getElementById('matriculaDevolucao').value || '').trim();
    const nome = document.getElementById('nomeFuncionarioDevolucao').value || '';
    const status = STATUS_LABELS.devolvido;

    if (!confirm(`Confirma a devolu√ß√£o do objeto "${objeto}"?`)) return;

    postToForms({
      objeto,
      matricula: mat,
      funcionario: nome,
      setor: currentSetor,
      status
    }).then(() => {
      showToast('Devolu√ß√£o registrada com sucesso!', 'success');
      showScreen('mainMenu');
    }).catch(err => {
      showToast('Falha ao enviar ao Forms: ' + err.message, 'error');
    });
  }

  async function finalizarInventario() {
    if (!currentFuncionario) { showToast('Identifique o funcion√°rio pela matr√≠cula', 'error'); return; }

    const linhas = Array.from(document.querySelectorAll('#listaObjetosInventario > div'));
    if (linhas.length === 0) { showToast('Nenhum objeto para inventariar', 'error'); return; }

    if (!confirm('Confirma a finaliza√ß√£o do invent√°rio e envio dos status ao Forms?')) return;

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    try {
      const nome = document.getElementById('nomeFuncionarioInventario').value || '';
      for (const row of linhas) {
        const objeto = row.dataset.objeto;
        const group  = row.dataset.group;
        const checked = document.querySelector(`input[name="${group}"]:checked`);
        const status  = checked ? checked.value : STATUS_LABELS.devolvido;
        await postToForms({
          objeto,
          matricula: currentFuncionario.id,
          funcionario: nome,
          setor: currentSetor,
          status
        });
        await sleep(300); // evita descarte por envios muito r√°pidos
      }
      showToast('Invent√°rio enviado com sucesso!', 'success');
      showScreen('mainMenu');
    } catch (err) {
      showToast('Falha ao enviar ao Forms: ' + err.message, 'error');
    }
  }

  // ====================== BOOT ======================
  document.getElementById('btnEntrar').addEventListener('click', () => {
    const setor = document.getElementById('setorSelect').value;
    if (!setor) { showToast('Selecione um setor', 'error'); return; }
    currentSetor = setor;
    document.getElementById('setorAtual').textContent = 'Setor: ' + currentSetor;
    showScreen('mainMenu');
  });
  document.getElementById('btnSair').addEventListener('click', logout);

  window.addEventListener('DOMContentLoaded', async () => {
    await loadData();
  });
  </script>
</body>
</html>
