<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KnifeControl Usu√°rio ‚Äî Fallback Google Forms (Sync)</title>
  <link rel="icon" type="image/png" href="https://pfst.cf2.poecdn.net/base/image/66a86ff2e9d405ae0301524bd658a3243a0dd6b3e9b05bb2cf53c4d11af08062?w=71&h=69" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { box-sizing: border-box; margin: 0; padding: 0; }
    .app-header { background: white; border-bottom: 2px solid #e5e7eb; padding: 8px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .app-header img { height: 50px; width: auto; display: block; margin: 0 auto; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>

<body class="bg-gray-100">
  <div class="app-header">
    <img src="https://pfst.cf2.poecdn.net/base/image/b4c6aca4c7db7589b9f0de13c8ee90d92d0ff180d82b105e4e1961cae846d611?w=225&h=92" alt="LSG Sky Chefs" />
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="bg-white rounded-2xl shadow-2xl p-8">
        <div class="text-center mb-6">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">üî™ KnifeControl</h1>
          <p class="text-gray-600 mt-2">Sistema de Controle de Objetos ‚Äî <span class="font-semibold">Modo Fallback (Google Forms)</span></p>
        </div>

        <form id="loginForm" class="space-y-6">
          <div>
            <label for="setor" class="block text-sm font-medium text-gray-700 mb-2">Setor</label>
            <select id="setor" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Carregando setores...</option>
            </select>
          </div>

          <div>
            <label for="senha" class="block text-sm font-medium text-gray-700 mb-2">Senha do setor</label>
            <input type="password" id="senha" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Digite a senha do setor" />
          </div>

          <div id="connectionStatus" class="text-center text-sm text-gray-600">‚è≥ Carregando dados do <b>planilha.json</b>‚Ä¶</div>
          <button id="btnEntrar" type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg">Entrar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- MENU -->
  <div id="mainMenu" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <div class="text-center">
          <h2 class="text-xl font-bold text-gray-800">Bem-vindo!</h2>
          <p class="text-gray-600" id="setorAtual">Setor: </p>
          <div class="mt-2 text-xs text-green-600 flex items-center justify-content-center">
            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
            <span id="syncStatus">Sincronizando status com planilha do Forms‚Ä¶</span>
          </div>
        </div>
      </div>

      <div class="space-y-4">
        <button onclick="showScreen('retiradaScreen')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üì§</div>
          <div class="text-xl font-bold">Retirada de Objeto</div>
          <div class="text-sm opacity-90 mt-1">Registrar retirada (marca como <b>Em Uso</b>)</div>
        </button>

        <button onclick="showScreen('devolucaoScreen')" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üì•</div>
          <div class="text-xl font-bold">Devolu√ß√£o de Objeto</div>
          <div class="text-sm opacity-90 mt-1">Devolver apenas itens <b>Em Uso</b> no seu setor</div>
        </button>

        <button onclick="showScreen('inventarioScreen')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üìã</div>
          <div class="text-xl font-bold">Invent√°rio de Fim de Turno</div>
          <div class="text-sm opacity-90 mt-1">Bloqueia se houver itens <b>Em Uso</b></div>
        </button>

        <button onclick="logout()" class="w-full bg-gray-200 text-gray-700 p-4 rounded-xl hover:bg-gray-300 transition duration-300 mt-4">
          <div class="text-sm font-semibold">üö™ Sair</div>
        </button>
      </div>
    </div>
  </div>

  <!-- RETIRADA -->
  <div id="retiradaScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üì§</span> Retirada de Objeto
        </h2>

        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-gray-600">Digite a matr√≠cula</div>
        </div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">Matr√≠cula</label>
          <input type="text" id="codigoManualRetirada" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="C√≥digo / Matr√≠cula" />
          <button onclick="identificarManual('retirada')" class="w-full mt-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Identificar</button>
        </div>

        <div id="funcionarioInfoRetirada" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-4 mb-4"></div>
        <div id="leituraInfoRetirada" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-gray-700"></div>

        <div id="objetoSelectionRetirada" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Objeto:</label>
          <select id="objetoRetirada" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4">
            <option value="">Selecione um objeto...</option>
          </select>
          <button onclick="confirmarRetirada()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300">Confirmar Retirada</button>
        </div>

        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- DEVOLU√á√ÉO -->
  <div id="devolucaoScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üì•</span> Devolu√ß√£o de Objeto
        </h2>
        <div id="devolucaoLista" class="grid grid-cols-2 gap-2 mb-2"></div>
        <div id="devolucaoEmpty" class="hidden text-gray-500 text-sm p-3 border rounded-lg">Nenhum objeto em uso neste setor.</div>
        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- INVENT√ÅRIO -->
  <div id="inventarioScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üìã</span> Invent√°rio de Fim de Turno
        </h2>

        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-gray-600">Digite a matr√≠cula</div>
        </div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">Matr√≠cula</label>
          <input type="text" id="codigoManualInventario" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="C√≥digo / Matr√≠cula" />
          <button onclick="identificarManual('inventario')" class="w-full mt-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Identificar</button>
        </div>

        <div id="funcionarioInfoInventario" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-4 mb-4"></div>
        <div id="leituraInfoInventario" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-gray-700"></div>

        <div id="statusObjetosInventario" class="hidden mb-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Status dos Objetos do Setor:</h3>
          <div id="listaObjetosInventario" class="space-y-2"></div>
        </div>

        <div id="inventarioActions" class="hidden">
          <button id="btnFinalizarInventario" onclick="finalizarInventario()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">Finalizar Invent√°rio</button>
          <div id="inventarioAviso" class="text-sm text-red-600 mt-2 hidden">‚ö†Ô∏è H√° objetos em uso. Finaliza√ß√£o bloqueada.</div>
        </div>

        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- CONFIRM -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all">
      <div class="text-center mb-6">
        <div class="text-4xl mb-3" id="confirmIcon">‚ùì</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2" id="confirmTitle">Confirmar A√ß√£o</h3>
        <p class="text-gray-600" id="confirmMessage"></p>
      </div>
      <div class="flex space-x-3">
        <button onclick="cancelConfirm()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300">N√£o</button>
        <button id="confirmButton" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Sim</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="hidden fixed top-20 right-4 z-50 max-w-sm">
    <div id="toastContent" class="rounded-xl shadow-2xl p-4 transform transition-all"></div>
  </div>

  <script>
    // =================== CONFIG ===================
    // Este app usa SOMENTE os dados de /planilha.json (sem dados locais embutidos).
    // Estrutura esperada (conforme seu arquivo):
    // { setores: [...], setoresSenha: { [setor]: senha }, objetos: { [setor]: [...] }, funcionarios: [{matricula,nome,setor}] }

    const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScKBnRZ2StGX5qIqGVPrsXbt-hTbTawDYWqR3iEELCq9of7Xw/formResponse';
    const FORMS_FIELDS = {
      objeto: 'entry.587663124',
      matricula: 'entry.360956002',
      funcionario: 'entry.245251034',
      setor: 'entry.431322508',
      timestamp: 'entry.2072805918',
      emUso: 'entry.1169418597',
      devolvido: 'entry.2075298705'
    };
    const CHECKBOX_LABELS = { emUso: 'Em Uso', devolvido: 'Devolvido' };

    const FORMS_RESP_GVIS_URL = 'https://docs.google.com/spreadsheets/d/1k3K5NBme5EklfF4o_yfSCJzTSXrXFA2AKdFFvnkeMcE/gviz/tq?tqx=out:json&gid=324654921';
    const EMPLOYEE_JSON_URL = '/planilha.json';

    let currentSetor = '';
    let currentFuncionario = null; // { id, nome, setor, dataLeitura }

    // Dados carregados do planilha.json
    let SETORES = [];
    let SETORES_SENHA = {};
    let OBJETOS = {};
    let FUNCIONARIOS = [];

    // √çndices para performance
    let FUNC_BY_MAT = new Map();

    // Status (cache local + remoto)
    let REMOTE_STATUS = {}; // { [setor]: { [objeto]: {status, ts, funcionario?, matricula?} } }
    const STORAGE_KEY = 'KC_STATUS_V1';

    let CONFIG_OK = false;

    function loadStatus(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(e){ return {}; } }
    function saveStatus(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
    function getSectorStatusLocal(setor){ const db=loadStatus(); return db[setor] || {}; }
    function setObjectStatusLocal(setor, objeto, status, meta = {}) {
      const db = loadStatus();
      if (!db[setor]) db[setor] = {};
      db[setor][objeto] = { status, ts: new Date().toISOString(), ...meta };
      saveStatus(db);
    }

    function getMergedStatus(setor){
      const remote = REMOTE_STATUS[setor] || {};
      const local = getSectorStatusLocal(setor) || {};
      const merged = {};
      const keys = new Set([...Object.keys(local), ...Object.keys(remote)]);
      keys.forEach(obj => {
        const r = remote[obj];
        const l = local[obj];
        if (r && l) {
          const rTs = (typeof r.ts === 'number') ? r.ts : (Date.parse(r.ts) || 0);
          const lTs = Date.parse(l.ts) || 0;
          merged[obj] = (rTs >= lTs) ? r : l;
        } else {
          merged[obj] = r || l;
        }
      });
      return merged;
    }

    function setSyncStatus(msg, ok=true){
      const el=document.getElementById('syncStatus');
      if(!el) return;
      el.textContent = (ok? '‚úÖ ' : '‚ö†Ô∏è ') + msg;
      el.className = ok? 'text-green-600' : 'text-yellow-700';
    }

    // =================== Carregamento do planilha.json ===================
    async function loadPlanilhaJson(){
      const statusEl = document.getElementById('connectionStatus');
      const setorSelect = document.getElementById('setor');

      try{
        const resp = await fetch(EMPLOYEE_JSON_URL, { cache:'no-store' });
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const j = await resp.json();

        if(!j || typeof j !== 'object') throw new Error('JSON inv√°lido');
        if(!Array.isArray(j.setores)) throw new Error('Campo "setores" ausente/ inv√°lido');
        if(!j.setoresSenha || typeof j.setoresSenha !== 'object') throw new Error('Campo "setoresSenha" ausente/ inv√°lido');
        if(!j.objetos || typeof j.objetos !== 'object') throw new Error('Campo "objetos" ausente/ inv√°lido');
        if(!Array.isArray(j.funcionarios)) throw new Error('Campo "funcionarios" ausente/ inv√°lido');

        SETORES = j.setores;
        SETORES_SENHA = j.setoresSenha;
        OBJETOS = j.objetos;
        FUNCIONARIOS = j.funcionarios;

        // Criar √≠ndice por matr√≠cula
        FUNC_BY_MAT = new Map();
        for(const f of FUNCIONARIOS){
          if(!f) continue;
          const m = String(f.matricula || '').trim();
          if(!m) continue;
          FUNC_BY_MAT.set(m, {
            matricula: m,
            nome: String(f.nome || '').trim(),
            setor: String(f.setor || '').trim()
          });
        }

        // Carregar setores no select
        setorSelect.innerHTML = '<option value="">Selecione um setor...</option>';
        SETORES.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          setorSelect.appendChild(opt);
        });

        CONFIG_OK = true;
        statusEl.className = 'text-center text-sm text-green-600';
        statusEl.innerHTML = '‚úÖ Dados carregados do <b>planilha.json</b>';
      }catch(err){
        console.error('[KC] Falha ao carregar planilha.json:', err);
        CONFIG_OK = false;

        // UI de erro
        if(statusEl){
          statusEl.className = 'text-center text-sm text-red-600';
          statusEl.textContent = '‚ùå Falha ao carregar planilha.json (verifique se o arquivo est√° na mesma pasta do site)';
        }
        if(setorSelect){
          setorSelect.innerHTML = '<option value="">Erro ao carregar setores</option>';
        }
        showToast('N√£o foi poss√≠vel carregar o planilha.json. Login bloqueado.', 'error');
      }
    }

    // =================== TOAST ===================
    function showToast(message, type='success'){
      const toast=document.getElementById('toast');
      const toastContent=document.getElementById('toastContent');
      const bg= type==='success'?'bg-green-500':'bg-red-500';
      const icon= type==='success'?'‚úÖ':'‚ùå';
      toastContent.className=`rounded-xl shadow-2xl p-4 text-white ${bg}`;
      toastContent.innerHTML=`<div class="flex items-center space-x-3"><div class="text-2xl">${icon}</div><div class="flex-1 font-semibold">${message}</div></div>`;
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'),3200);
    }

    // =================== LOGIN ===================
    document.getElementById('loginForm').addEventListener('submit', (e)=>{
      e.preventDefault();

      if(!CONFIG_OK){
        showToast('Dados n√£o carregados. Verifique o arquivo planilha.json.', 'error');
        return;
      }

      const setor=document.getElementById('setor').value;
      const senha=document.getElementById('senha').value;

      if(!setor || !senha){
        showToast('Por favor, preencha todos os campos','error');
        return;
      }

      const senhaEsperada = SETORES_SENHA[setor];
      if(!senhaEsperada){
        showToast('Setor sem senha cadastrada no planilha.json','error');
        return;
      }
      if(String(senhaEsperada) !== String(senha)){
        showToast('Senha incorreta','error');
        return;
      }

      currentSetor = setor;
      document.getElementById('setorAtual').textContent = 'Setor: ' + currentSetor;
      showScreen('mainMenu');
      showToast('Login realizado com sucesso!','success');
      refreshRemoteStatus();
    });

    function logout(){
      currentSetor='';
      currentFuncionario=null;
      document.getElementById('senha').value='';
      document.getElementById('setor').value='';
      showScreen('loginScreen');
    }

    // =================== NAVEGA√á√ÉO ===================
    function showScreen(id){
      ['loginScreen','mainMenu','retiradaScreen','devolucaoScreen','inventarioScreen']
        .forEach(s=>document.getElementById(s).classList.add('hidden'));
      const el=document.getElementById(id);
      el.classList.remove('hidden');
      el.classList.add('fade-in');

      if(id==='retiradaScreen'){
        loadObjetosDisponiveis();
        bindMatriculaAutoFill('retirada');
      }
      if(id==='devolucaoScreen'){
        montarListaDevolucao();
      }
      if(id==='inventarioScreen'){
        bindMatriculaAutoFill('inventario');
        montarInventario();
      }
    }

    // =================== Funcion√°rio (somente matr√≠cula digitada) ===================
    function bindMatriculaAutoFill(context){
      const inputId = context==='retirada' ? 'codigoManualRetirada' : 'codigoManualInventario';
      const el = document.getElementById(inputId);
      if(!el) return;
      el.addEventListener('input', ()=> autoFillNomeFromMatricula(context));
      el.addEventListener('blur', ()=> autoFillNomeFromMatricula(context));
    }

    function getFuncionarioByMatricula(m){
      const key = String(m || '').trim();
      return FUNC_BY_MAT.get(key) || null;
    }

    function autoFillNomeFromMatricula(context){
      const inputId = context==='retirada' ? 'codigoManualRetirada' : 'codigoManualInventario';
      const m = (document.getElementById(inputId)?.value || '').trim();
      if(!m) return;
      const f = getFuncionarioByMatricula(m);
      if(currentFuncionario && currentFuncionario.id === m && f){
        currentFuncionario.nome = f.nome;
        currentFuncionario.setor = f.setor;
      }
    }

    async function identificarManual(context){
      if(!CONFIG_OK){ showToast('Dados n√£o carregados. Verifique o planilha.json.','error'); return; }

      const inputId = context==='retirada' ? 'codigoManualRetirada' : 'codigoManualInventario';
      const codigo = document.getElementById(inputId).value.trim();
      if(!codigo){ showToast('Por favor, digite a matr√≠cula','error'); return; }

      const f = getFuncionarioByMatricula(codigo);
      if(!f){ showToast('Matr√≠cula n√£o cadastrada.','error'); return; }

      currentFuncionario = {
        id: String(f.matricula),
        nome: f.nome || '',
        setor: f.setor || '', // setor do funcion√°rio (vem do planilha.json)
        dataLeitura: new Date()
      };

      if(context==='retirada'){
        showFuncionarioInfo();
        loadObjetosDisponiveis();
      } else {
        showFuncionarioInfoInventario();
        montarInventario();
      }
    }

    function showFuncionarioInfo(){
      const info=document.getElementById('funcionarioInfoRetirada');
      const leitura=document.getElementById('leituraInfoRetirada');
      const selection=document.getElementById('objetoSelectionRetirada');
      info.classList.remove('hidden');
      leitura.classList.remove('hidden');
      selection.classList.remove('hidden');

      const nomeTexto = currentFuncionario.nome ? currentFuncionario.nome : '(nome n√£o cadastrado)';
      const setorTexto = currentFuncionario.setor ? currentFuncionario.setor : '(setor n√£o cadastrado)';
      info.innerHTML = `<div class="grid grid-cols-1 gap-2">
        <div><strong>üìã Matr√≠cula:</strong> ${currentFuncionario.id}</div>
        <div>
          <label class="text-sm text-gray-700 mt-1"><strong>üë§ Nome:</strong></label>
          <div class="w-full px-3 py-2 border border-green-300 rounded-lg bg-green-100 text-gray-800 select-none cursor-not-allowed" aria-readonly="true">${nomeTexto}</div>
        </div>
        <div><strong>üè¢ Setor:</strong> ${setorTexto}</div>
      </div>`;
      leitura.innerHTML = `<div><strong>üïê Leitura:</strong> ${new Date(currentFuncionario.dataLeitura).toLocaleString('pt-BR')}</div>`;
    }

    function showFuncionarioInfoInventario(){
      const info=document.getElementById('funcionarioInfoInventario');
      const leitura=document.getElementById('leituraInfoInventario');
      info.classList.remove('hidden');
      leitura.classList.remove('hidden');

      const nomeTexto = currentFuncionario?.nome ? currentFuncionario.nome : '(nome n√£o cadastrado)';
      const setorTexto = currentFuncionario?.setor ? currentFuncionario.setor : '(setor n√£o cadastrado)';
      info.innerHTML = `<div class="grid grid-cols-1 gap-2">
        <div><strong>üìã Matr√≠cula:</strong> ${currentFuncionario.id}</div>
        <div>
          <label class="text-sm text-gray-700 mt-1"><strong>üë§ Nome:</strong></label>
          <div class="w-full px-3 py-2 border border-green-300 rounded-lg bg-green-100 text-gray-800 select-none cursor-not-allowed" aria-readonly="true">${nomeTexto}</div>
        </div>
        <div><strong>üè¢ Setor:</strong> ${setorTexto}</div>
      </div>`;
      leitura.innerHTML = `<div><strong>üïê Leitura:</strong> ${new Date(currentFuncionario.dataLeitura).toLocaleString('pt-BR')}</div>`;
    }

    // =================== Objetos ===================
    function loadObjetosDisponiveis(){
      const select=document.getElementById('objetoRetirada');
      select.innerHTML='<option value="">Selecione um objeto...</option>';
      const lista = (OBJETOS[currentSetor] || []);
      lista.forEach(nome=>{
        const o=document.createElement('option');
        o.value=nome;
        o.textContent=nome;
        select.appendChild(o);
      });
    }

    function confirmarRetirada(){
      const objeto = (document.getElementById('objetoRetirada').value || '').trim();
      if(!objeto){ showToast('Selecione o objeto','error'); return; }
      if(!currentFuncionario){ showToast('Identifique o funcion√°rio primeiro','error'); return; }

      const merged = getMergedStatus(currentSetor);
      const rec = merged[objeto];
      const st = typeof rec==='string' ? rec : (rec?.status || 'Devolvido');
      if(st==='Em Uso'){ showToast('Este objeto j√° est√° Em Uso','error'); return; }

      const nome = currentFuncionario.nome || '';
      showConfirm(`Confirma a retirada do objeto "${objeto}"?`, async ()=>{
        try{
          await postToForms({ objeto, matricula: currentFuncionario.id, funcionario: nome, setor: currentSetor, status:'Em Uso' });
          setObjectStatusLocal(currentSetor, objeto, 'Em Uso', { funcionario: nome, matricula: currentFuncionario.id });
          showToast('Retirada registrada com sucesso!','success');
          setTimeout(refreshRemoteStatus, 2000);

          // reset
          currentFuncionario=null;
          document.getElementById('funcionarioInfoRetirada').classList.add('hidden');
          document.getElementById('leituraInfoRetirada').classList.add('hidden');
          document.getElementById('objetoSelectionRetirada').classList.add('hidden');
          document.getElementById('codigoManualRetirada').value='';
          setTimeout(()=>showScreen('mainMenu'),700);
        }catch(err){
          showToast('Falha ao enviar ao Forms: ' + (err?.message || err),'error');
        }
      });
    }

    function montarListaDevolucao(){
      const grid = document.getElementById('devolucaoLista');
      const empty = document.getElementById('devolucaoEmpty');
      grid.innerHTML='';

      const merged = getMergedStatus(currentSetor);
      const emUsoEntries = Object.entries(merged).filter(([obj, rec])=>{
        const st = (typeof rec==='string' ? rec : (rec?.status || 'Devolvido'));
        return st === 'Em Uso';
      });

      if(emUsoEntries.length===0){ empty.classList.remove('hidden'); return; }
      else { empty.classList.add('hidden'); }

      emUsoEntries.forEach(([nomeObj, rec])=>{
        let ts = (typeof rec === 'object' && rec?.ts) ? rec.ts : null;
        let funcionario = (typeof rec === 'object' && rec?.funcionario) ? rec.funcionario : '';
        let dt = null;
        if(ts != null){
          dt = (typeof ts === 'number') ? new Date(ts) : new Date(ts);
          if(isNaN(dt.getTime())) dt = null;
        }
        const dataHora = dt ? dt.toLocaleString('pt-BR') : 'data/hora n√£o dispon√≠vel';
        const nomeFuncionario = funcionario || 'funcion√°rio n√£o identificado';

        const btn=document.createElement('button');
        btn.className='px-3 py-2 rounded-lg bg-blue-50 hover:bg-blue-100 border text-left';
        btn.onclick=()=> confirmarDevolucaoObjeto(nomeObj);
        btn.innerHTML = `<div class="font-semibold text-blue-700">${nomeObj}</div>
          <div class="text-xs text-gray-600 mt-1">
            <span class="mr-2">üïê ${dataHora}</span><span>üë§ ${nomeFuncionario}</span>
          </div>`;
        grid.appendChild(btn);
      });
    }

    function confirmarDevolucaoObjeto(objeto){
      showConfirm(`Confirmar devolu√ß√£o do objeto "${objeto}"?`, async ()=>{
        try{
          await postToForms({ objeto, matricula: '', funcionario: '', setor: currentSetor, status:'Devolvido' });
          setObjectStatusLocal(currentSetor, objeto, 'Devolvido');
          showToast('Devolu√ß√£o registrada com sucesso!','success');
          setTimeout(refreshRemoteStatus, 2000);
          montarListaDevolucao();
          setTimeout(()=>showScreen('mainMenu'),700);
        }catch(err){
          showToast('Falha ao enviar ao Forms: ' + (err?.message || err),'error');
        }
      });
    }

    function montarInventario(){
      const container=document.getElementById('listaObjetosInventario');
      const statusDiv=document.getElementById('statusObjetosInventario');
      const actionsDiv=document.getElementById('inventarioActions');
      const aviso=document.getElementById('inventarioAviso');

      container.innerHTML='';
      const lista = (OBJETOS[currentSetor] || []);
      statusDiv.classList.remove('hidden');
      actionsDiv.classList.remove('hidden');

      let existeEmUso=false;
      const merged = getMergedStatus(currentSetor);

      lista.forEach((nome)=>{
        const rec = merged[nome];
        const st = typeof rec==='string' ? rec : (rec?.status || 'Devolvido');
        if(st==='Em Uso') existeEmUso=true;

        const row=document.createElement('div');
        row.className='flex items-center justify-between p-3 border border-gray-200 rounded-lg';
        row.innerHTML = `<div class="font-semibold text-gray-800">${nome}</div>` +
          `<div class="text-sm">` +
          (st==='Em Uso'
            ? `<span class='bg-red-100 text-red-700 px-3 py-1 rounded-full'>Em Uso</span>`
            : `<span class='bg-green-100 text-green-700 px-3 py-1 rounded-full'>Devolvido</span>`) +
          `</div>`;
        container.appendChild(row);
      });

      const btn = document.getElementById('btnFinalizarInventario');
      if(existeEmUso){ btn.disabled=true; aviso.classList.remove('hidden'); }
      else { btn.disabled=false; aviso.classList.add('hidden'); }
    }

    async function finalizarInventario(){
      if(!currentFuncionario){ showToast('Identifique o funcion√°rio primeiro','error'); return; }

      const nome = currentFuncionario.nome || '';
      const lista = (OBJETOS[currentSetor] || []);
      const merged = getMergedStatus(currentSetor);

      const algumEmUso = Object.values(merged).some(rec => (typeof rec==='string' ? rec : (rec?.status || 'Devolvido'))==='Em Uso');
      if(algumEmUso){ showToast('H√° objetos Em Uso. Invent√°rio bloqueado.','error'); return; }

      showConfirm('Confirmar finaliza√ß√£o do invent√°rio e envio ao Forms?', async ()=>{
        try{
          for(const objeto of lista){
            const rec = merged[objeto];
            const status = typeof rec==='string' ? rec : (rec?.status || 'Devolvido');
            await postToForms({ objeto, matricula: currentFuncionario.id, funcionario: nome, setor: currentSetor, status });
          }
          showToast('Invent√°rio enviado com sucesso!','success');
          setTimeout(refreshRemoteStatus, 2000);

          // reset
          currentFuncionario=null;
          document.getElementById('funcionarioInfoInventario').classList.add('hidden');
          document.getElementById('leituraInfoInventario').classList.add('hidden');
          document.getElementById('statusObjetosInventario').classList.add('hidden');
          document.getElementById('inventarioActions').classList.add('hidden');
          document.getElementById('codigoManualInventario').value='';
          setTimeout(()=>showScreen('mainMenu'),700);
        }catch(err){
          showToast('Falha ao enviar ao Forms: ' + (err?.message || err),'error');
        }
      });
    }

    async function postToForms({ objeto, matricula, funcionario, setor, status }){
      const fd=new FormData();
      fd.append(FORMS_FIELDS.objeto, objeto || '');
      fd.append(FORMS_FIELDS.matricula, matricula || '');
      fd.append(FORMS_FIELDS.funcionario, funcionario || '');
      fd.append(FORMS_FIELDS.setor, setor || '');
      fd.append(FORMS_FIELDS.timestamp, new Date().toISOString());
      if(status==='Em Uso') fd.append(FORMS_FIELDS.emUso, CHECKBOX_LABELS.emUso);
      if(status==='Devolvido') fd.append(FORMS_FIELDS.devolvido, CHECKBOX_LABELS.devolvido);
      await fetch(GOOGLE_FORM_URL, { method:'POST', mode:'no-cors', body: fd });
    }

    // =================== GViz Sync ===================
    async function refreshRemoteStatus(){
      if(!FORMS_RESP_GVIS_URL || FORMS_RESP_GVIS_URL.startsWith('COLE_AQUI')){
        setSyncStatus('Configure a URL da planilha do Forms em GViz JSON', false);
        return;
      }
      try{
        const resp = await fetch(FORMS_RESP_GVIS_URL, { cache:'no-store' });
        if(!resp.ok){ setSyncStatus('Falha ao acessar planilha do Forms ('+resp.status+')', false); return; }
        const txt = await resp.text();
        const jsonStr = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1);
        const gviz = JSON.parse(jsonStr);
        const cols = (gviz.table.cols||[]).map(c=>c.label?.trim());
        const rows = gviz.table.rows||[];

        const idx = {
          objeto: cols.findIndex(x=> /objeto/i.test(x||'')),
          matricula: cols.findIndex(x=> /matr[i√≠]cula/i.test(x||'')),
          funcionario: cols.findIndex(x=> /funcion[√°a]rio/i.test(x||'')),
          setor: cols.findIndex(x=> /setor/i.test(x||'')),
          timestamp: cols.findIndex(x=> /timestamp|data|hora/i.test(x||'')),
          emUso: cols.findIndex(x=> /em\s*uso/i.test(x||'')),
          devolvido: cols.findIndex(x=> /devolvid/i.test(x||''))
        };

        const records = rows.map(r=>{
          const c = r.c||[];
          const get = i => (i>=0 && c[i] && c[i].v!=null) ? String(c[i].v) : '';
          return {
            objeto: get(idx.objeto).trim(),
            matricula: get(idx.matricula).trim(),
            funcionario: get(idx.funcionario).trim(),
            setor: get(idx.setor).trim(),
            timestamp: get(idx.timestamp).trim(),
            emUso: /em\s*uso/i.test(get(idx.emUso)),
            devolvido: /devolvid/i.test(get(idx.devolvido))
          };
        }).filter(r=>r.objeto && r.setor);

        const byKey = {};
        for(const r of records){
          const key = r.setor+'\u0001'+r.objeto;
          const ts = Date.parse(r.timestamp) || 0;
          if(!byKey[key] || ts > byKey[key].ts){
            if(r.emUso && !r.devolvido){
              byKey[key] = { status: 'Em Uso', ts, funcionario: r.funcionario||'', matricula: r.matricula||'' };
            } else {
              byKey[key] = { status: 'Devolvido', ts };
            }
          }
        }

        REMOTE_STATUS = {};
        Object.entries(byKey).forEach(([key,val])=>{
          const [setor,objeto] = key.split('\u0001');
          if(!REMOTE_STATUS[setor]) REMOTE_STATUS[setor] = {};
          REMOTE_STATUS[setor][objeto] = val;
        });

        setSyncStatus('Status sincronizado com a planilha do Forms');
      }catch(e){
        console.error(e);
        setSyncStatus('Erro ao ler GViz JSON do Forms', false);
      }
    }

    // =================== Modal ===================
    let confirmCallback=null;
    function showConfirm(message, callback){
      const modal=document.getElementById('confirmModal');
      const msg=document.getElementById('confirmMessage');
      const btn=document.getElementById('confirmButton');
      msg.textContent=message;
      modal.classList.remove('hidden');
      confirmCallback=callback;
      btn.onclick=function(){
        modal.classList.add('hidden');
        if(confirmCallback){ confirmCallback(); confirmCallback=null; }
      }
    }
    function cancelConfirm(){ document.getElementById('confirmModal').classList.add('hidden'); confirmCallback=null; }

    function voltarMenu(){
      currentFuncionario=null;
      document.getElementById('codigoManualRetirada').value='';
      document.getElementById('codigoManualInventario').value='';
      document.getElementById('funcionarioInfoRetirada').classList.add('hidden');
      document.getElementById('leituraInfoRetirada').classList.add('hidden');
      document.getElementById('objetoSelectionRetirada').classList.add('hidden');
      document.getElementById('funcionarioInfoInventario').classList.add('hidden');
      document.getElementById('leituraInfoInventario').classList.add('hidden');
      document.getElementById('statusObjetosInventario').classList.add('hidden');
      document.getElementById('inventarioActions').classList.add('hidden');
      showScreen('mainMenu');
    }

    async function boot(){
      await loadPlanilhaJson();
      setInterval(()=>{ if(currentSetor) refreshRemoteStatus(); }, 15000);
    }

    window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
