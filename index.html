<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KnifeControl Usu√°rio ‚Äî Fallback Google Forms</title>
  <link rel="icon" type="image/png" href="https://pfst.cf2.poecdn.net/base/image/66a86ff2e9d405ae0301524bd658a3243a0dd6b3e9b05bb2cf53c4d11af08062?w=71&h=69" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <style>
    body { box-sizing: border-box; margin: 0; padding: 0; }
    .app-header { background: white; border-bottom: 2px solid #e5e7eb; padding: 8px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .app-header img { height: 50px; width: auto; display: block; margin: 0 auto; }
    .scanner-container { position: relative; width: 100%; height: 300px; background: #000; border: 2px solid #3b82f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; overflow: hidden; }
    .scanner-container:hover { border-color: #1d4ed8; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    .scanner-container video { width: 100%; height: 100%; object-fit: cover; }
    .scanner-inactive { background: linear-gradient(45deg, #f3f4f6, #e5e7eb); border: 2px dashed #9ca3af; }
    .scanner-inactive:hover { border-color: #3b82f6; background: linear-gradient(45deg, #eff6ff, #dbeafe); }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-gray-100">
  <div class="app-header">
    <img src="https://pfst.cf2.poecdn.net/base/image/b4c6aca4c7db7589b9f0de13c8ee90d92d0ff180d82b105e4e1961cae846d611?w=225&h=92" alt="LSG Sky Chefs" />
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="bg-white rounded-2xl shadow-2xl p-8">
        <div class="text-center mb-6">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">üî™ KnifeControl</h1>
          <p class="text-gray-600 mt-2">Sistema de Controle de Objetos ‚Äî <span class="font-semibold">Modo Fallback (Google Forms)</span></p>
        </div>
        <form id="loginForm" class="space-y-6">
          <div>
            <label for="setor" class="block text-sm font-medium text-gray-700 mb-2">Setor</label>
            <select id="setor" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Carregando setores...</option>
            </select>
          </div>
          <div>
            <label for="senha" class="block text-sm font-medium text-gray-700 mb-2">Senha do setor</label>
            <input type="password" id="senha" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Digite a senha do setor" />
          </div>
          <div id="connectionStatus" class="text-center text-sm text-green-600">‚úÖ Conectado (Fallback Google Forms)</div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg">Entrar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- MENU PRINCIPAL -->
  <div id="mainMenu" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <div class="text-center">
          <h2 class="text-xl font-bold text-gray-800">Bem-vindo!</h2>
          <p class="text-gray-600" id="setorAtual">Setor: </p>
          <div class="mt-2 text-xs text-green-600 flex items-center justify-center">
            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
            Modo Fallback ativo ‚Äî registros ser√£o enviados ao Google Forms
          </div>
        </div>
      </div>
      <div class="space-y-4">
        <button onclick="showScreen('retiradaScreen')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üì§</div>
          <div class="text-xl font-bold">Retirada de Objeto</div>
          <div class="text-sm opacity-90 mt-1">Registrar retirada (marca como <b>Em Uso</b>)</div>
        </button>
        <button onclick="showScreen('devolucaoScreen')" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üì•</div>
          <div class="text-xl font-bold">Devolu√ß√£o de Objeto</div>
          <div class="text-sm opacity-90 mt-1">Registrar devolu√ß√£o (marca como <b>Devolvido</b>)</div>
        </button>
        <button onclick="showScreen('inventarioScreen')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üìã</div>
          <div class="text-xl font-bold">Invent√°rio de Fim de Turno</div>
          <div class="text-sm opacity-90 mt-1">Enviar status (Devolvido/Em Uso) de todos os objetos do setor</div>
        </button>
        <button onclick="logout()" class="w-full bg-gray-200 text-gray-700 p-4 rounded-xl hover:bg-gray-300 transition duration-300 mt-4">
          <div class="text-sm font-semibold">üö™ Sair</div>
        </button>
      </div>
    </div>
  </div>

  <!-- RETIRADA -->
  <div id="retiradaScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üì§</span> Retirada de Objeto
        </h2>
        <div id="scannerRetirada" class="scanner-container scanner-inactive mb-4"></div>
        <div id="scanStatus-retirada" class="hidden mb-4 p-3 rounded-lg text-center font-semibold"></div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">ou Digite o C√≥digo do Funcion√°rio:</label>
          <div class="flex space-x-2">
            <input type="text" id="codigoManualRetirada" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="C√≥digo / Matr√≠cula" />
            <button onclick="identificarManual('retirada')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Identificar</button>
          </div>
        </div>

        <div id="funcionarioInfoRetirada" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-4 mb-4"></div>
        <div id="leituraInfoRetirada" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-gray-700"></div>

        <div id="objetoSelectionRetirada" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Objeto:</label>
          <select id="objetoRetirada" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3">
            <option value="">Selecione um objeto...</option>
          </select>
          <div class="text-xs text-gray-500 mb-3">Se n√£o encontrar na lista, digite abaixo:</div>
          <input type="text" id="objetoRetiradaManual" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Nome do objeto" />
          <button onclick="confirmarRetirada()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300">Confirmar Retirada</button>
        </div>

        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- DEVOLUCAO -->
  <div id="devolucaoScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üì•</span> Devolu√ß√£o de Objeto
        </h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Objeto</label>
          <input id="objetoDevolucao" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex.: Faca 01" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Matr√≠cula (opcional)</label>
          <input id="matriculaDevolucao" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Se dispon√≠vel" />
        </div>
        <button onclick="confirmarDevolucao()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300">Confirmar Devolu√ß√£o</button>
        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- INVENTARIO -->
  <div id="inventarioScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üìã</span> Invent√°rio de Fim de Turno
        </h2>
        <div id="scannerInventario" class="scanner-container scanner-inactive mb-4"></div>
        <div id="scanStatus-inventario" class="hidden mb-4 p-3 rounded-lg text-center font-semibold"></div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">ou Digite o C√≥digo do Funcion√°rio:</label>
          <div class="flex space-x-2">
            <input type="text" id="codigoManualInventario" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="C√≥digo / Matr√≠cula" />
            <button onclick="identificarManual('inventario')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Identificar</button>
          </div>
        </div>

        <div id="funcionarioInfoInventario" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-4 mb-4"></div>
        <div id="leituraInfoInventario" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-gray-700"></div>

        <div id="statusObjetosInventario" class="hidden mb-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Status dos Objetos do Setor:</h3>
          <div id="listaObjetosInventario" class="space-y-2"></div>
        </div>
        <div id="inventarioActions" class="hidden">
          <button id="btnFinalizarInventario" onclick="finalizarInventario()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">Finalizar Invent√°rio</button>
        </div>

        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIRMACAO -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all">
      <div class="text-center mb-6">
        <div class="text-4xl mb-3" id="confirmIcon">‚ùì</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2" id="confirmTitle">Confirmar A√ß√£o</h3>
        <p class="text-gray-600" id="confirmMessage"></p>
      </div>
      <div class="flex space-x-3">
        <button onclick="cancelConfirm()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300">N√£o</button>
        <button id="confirmButton" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Sim</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="hidden fixed top-20 right-4 z-50 max-w-sm">
    <div id="toastContent" class="rounded-xl shadow-2xl p-4 transform transition-all"></div>
  </div>

  <script>
    // ============ CONFIG FORMS (ATUALIZADO) ============
    const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScKBnRZ2StGX5qIqGVPrsXbt-hTbTawDYWqR3iEELCq9of7Xw/formResponse';
    const FORMS_FIELDS = {
      objeto:     'entry.587663124',
      matricula:  'entry.360956002',
      funcionario:'entry.245251034',
      setor:      'entry.431322508',
      timestamp:  'entry.2072805918',
      status:     'entry.1169418597' // Pergunta √∫nica "Detalhes Extras" (checkbox) com op√ß√µes "Em Uso" / "Devolvido"
    };
    const STATUS_LABELS = { emUso: 'Em Uso', devolvido: 'Devolvido' };

    // ============ DADOS LOCAIS ============
    const LOCAL_SETORES = ['Teste','A√ßougue','Coc√ß√£o','Confeitaria','Corte de Frios','Ensacamento de P√£es','Gard Manger','Padaria','Pr√©-Preparo','Montagem de Sandu√≠ches'];
    const LOCAL_OBJETOS = {
      'Teste': ['FACA TESTE'],
      'A√ßougue': ['95 ‚Äì FACA','100 ‚Äì FACA','107 ‚Äì FACA','108 ‚Äì FACA'],
      'Coc√ß√£o': ['45 ‚Äì FACA','51 ‚Äì FACA','52 ‚Äì FACA','53 ‚Äì FACA'],
      'Confeitaria': ['72 ‚Äì FACA','73 ‚Äì FACA','74 ‚Äì FACA'],
      'Corte de Frios': ['32 ‚Äì FACA','33 ‚Äì FACA'],
      'Ensacamento de P√£es': ['20 ‚Äì FACA','66 ‚Äì FACA'],
      'Gard Manger': ['02 ‚Äì TESOURA','17 ‚Äì FACA','18 ‚Äì FACA','44 ‚Äì FACA','45 ‚Äì FACA','48 ‚Äì FACA','49 ‚Äì FACA'],
      'Montagem de Sandu√≠ches': ['60 ‚Äì FACA','61 ‚Äì FACA','62 ‚Äì FACA','63 ‚Äì FACA','64 ‚Äì FACA','65 ‚Äì FACA','66 ‚Äì TESOURA'],
      'Padaria': ['88 ‚Äì FACA','89 ‚Äì FACA','0028199 ‚Äì ESTILETE','0028200 ‚Äì ESTILETE'],
      'Pr√©-Preparo': ['84 ‚Äì FACA','85 ‚Äì FACA','86 ‚Äì FACA','87 ‚Äì FACA','89 ‚Äì FACA','90 ‚Äì FACA','91 ‚Äì TESOURA']
    };
    const ENFORCE_LOCAL_PASSWORD = true;
    const LOCAL_SENHAS = {
      'Produ√ß√£o':'1234','Cozinha Quente':'1234','Cozinha Fria':'1234','Expedi√ß√£o':'1234','Teste':'a','A√ßougue':'acougue','Coc√ß√£o':'coccao','Confeitaria':'confeitaria','Corte de Frios':'frios','Ensacamento de P√£es':'ensacamento','Gard Manger':'gard','Padaria':'padaria','Pr√©-Preparo':'preparo','Montagem de Sandu√≠ches':'montagem'
    };

    // ============ ESTADO ============
    let currentSetor = '';
    let currentFuncionario = null; // { id, nome, setor, dataLeitura }
    let qrScanners = {}; let scannerActive = {};

    // ============ TOAST ============
    function showToast(message, type='success'){
      const toast=document.getElementById('toast');
      const toastContent=document.getElementById('toastContent');
      const bg= type==='success'?'bg-green-500':'bg-red-500';
      const icon= type==='success'?'‚úÖ':'‚ùå';
      toastContent.className=`rounded-xl shadow-2xl p-4 text-white ${bg}`;
      toastContent.innerHTML=`<div class="flex items-center space-x-3"><div class="text-2xl">${icon}</div><div class="flex-1 font-semibold">${message}</div></div>`;
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'),3000);
    }

    // ============ LOGIN & SETORES ============
    function loadSetores(){
      const setorSelect=document.getElementById('setor');
      setorSelect.innerHTML='<option value="">Selecione um setor...</option>';
      LOCAL_SETORES.forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; setorSelect.appendChild(opt); });
    }

    document.getElementById('loginForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const setor=document.getElementById('setor').value;
      const senha=document.getElementById('senha').value;
      if(!setor || !senha){ showToast('Por favor, preencha todos os campos','error'); return; }
      if(ENFORCE_LOCAL_PASSWORD){
        if(!LOCAL_SENHAS[setor] || LOCAL_SENHAS[setor]!==senha){ showToast('Senha incorreta','error'); return; }
      }
      currentSetor=setor;
      document.getElementById('setorAtual').textContent='Setor: '+currentSetor;
      showScreen('mainMenu');
      showToast('Login realizado com sucesso!','success');
    });

    function logout(){
      Object.keys(qrScanners).forEach(ctx=>{ if(qrScanners[ctx]){ qrScanners[ctx].stop().catch(()=>{}); }});
      currentSetor=''; currentFuncionario=null;
      document.getElementById('senha').value='';
      document.getElementById('setor').value='';
      showScreen('loginScreen');
    }

    // ============ NAVEGA√á√ÉO ============
    function showScreen(id){
      ['loginScreen','mainMenu','retiradaScreen','devolucaoScreen','inventarioScreen'].forEach(s=>document.getElementById(s).classList.add('hidden'));
      const el=document.getElementById(id);
      el.classList.remove('hidden');
      el.classList.add('fade-in');
      if(id==='retiradaScreen') loadObjetosDisponiveis();
      if(id==='inventarioScreen') prepararInventario();
    }

    // ============ QR CODE ============
    function initializeScanner(containerId, context){
      const container=document.getElementById(containerId);
      resetScanner(containerId, context);
      container.onclick= async function(){
        if(scannerActive[context]){ stopScanner(context); return; }
        try{
          container.innerHTML='<div id="qr-reader-'+context+'" style="width: 100%;"></div>';
          container.classList.remove('scanner-inactive');
          const scanner=new Html5Qrcode('qr-reader-'+context);
          qrScanners[context]=scanner;
          await scanner.start({facingMode:'environment'},{fps:10, qrbox:{width:250, height:250}}, (decodedText)=>{ processQRCode(decodedText, context); stopScanner(context); }, (error)=>{});
          scannerActive[context]=true;
          updateScanStatus(context, 'üì∑ C√¢mera ativa ‚Äî Aponte para o QR Code', 'loading');
        } catch(err){
          console.error('Erro ao iniciar scanner:', err);
          updateScanStatus(context,'‚ùå Erro ao acessar c√¢mera','error');
          resetScanner(containerId, context);
        }
      }
    }

    function stopScanner(context){
      if(qrScanners[context]){
        qrScanners[context].stop().then(()=>{ scannerActive[context]=false; const containerId= (context==='retirada'?'scannerRetirada':'scannerInventario'); resetScanner(containerId, context); }).catch(()=>{});
      }
    }

    function resetScanner(containerId, context){
      const c=document.getElementById(containerId);
      c.classList.add('scanner-inactive');
      c.innerHTML=`<div class="text-center text-gray-600 p-4"><div class="text-4xl mb-2">üì∑</div><div class="font-semibold">Toque para escanear QR Code</div><div class="text-sm mt-1">ou digite o c√≥digo abaixo</div></div>`;
      const st=document.getElementById('scanStatus-'+context);
      if(st){ st.classList.add('hidden'); st.textContent=''; }
    }

    function updateScanStatus(context, message, type){
      const el=document.getElementById('scanStatus-'+context);
      if(!el) return;
      el.classList.remove('hidden','bg-blue-100','bg-green-100','bg-red-100','text-blue-700','text-green-700','text-red-700');
      if(type==='loading'){ el.classList.add('bg-blue-100','text-blue-700'); }
      else if(type==='active'){ el.classList.add('bg-green-100','text-green-700'); }
      else if(type==='error'){ el.classList.add('bg-red-100','text-red-700'); }
      el.textContent=message;
    }

    async function processQRCode(code, context){
      const codigo=String(code||'').trim();
      if(!codigo){ showToast('QR inv√°lido','error'); return; }
      currentFuncionario={ id: codigo, nome:'', setor: currentSetor, dataLeitura: new Date() };
      if(context==='retirada'){ showFuncionarioInfo(); loadObjetosDisponiveis(); }
      if(context==='inventario'){ showFuncionarioInfoInventario(); prepararInventario(); }
      updateScanStatus(context,'‚úÖ Funcion√°rio identificado (edite o nome se necess√°rio)','active');
      setTimeout(()=>{ const st=document.getElementById('scanStatus-'+context); if(st) st.classList.add('hidden'); },2000);
    }

    async function identificarManual(context){
      const inputId= (context==='retirada'?'codigoManualRetirada':'codigoManualInventario');
      const codigo=document.getElementById(inputId).value.trim();
      if(!codigo){ showToast('Por favor, digite um c√≥digo','error'); return; }
      await processQRCode(codigo, context);
    }

    // ============ UI FUNCION√ÅRIO ============
    function showFuncionarioInfo(){
      const info=document.getElementById('funcionarioInfoRetirada');
      const leitura=document.getElementById('leituraInfoRetirada');
      const selection=document.getElementById('objetoSelectionRetirada');
      info.classList.remove('hidden');
      leitura.classList.remove('hidden');
      selection.classList.remove('hidden');
      info.innerHTML=`<div class="grid grid-cols-1 gap-2"><div><strong>üìã Matr√≠cula:</strong> ${currentFuncionario.id}</div><label class="text-sm text-gray-700 mt-1"><strong>üë§ Nome:</strong></label><input id="nomeFuncionarioRetirada" class="w-full px-3 py-2 border border-green-300 rounded-lg" placeholder="Digite o nome" /><div><strong>üè¢ Setor:</strong> ${currentFuncionario.setor}</div></div>`;
      const dataLeitura=currentFuncionario.dataLeitura||new Date();
      leitura.innerHTML=`<div><strong>üïê Leitura:</strong> ${new Date(dataLeitura).toLocaleString('pt-BR')}</div>`;
    }

    function showFuncionarioInfoInventario(){
      const info=document.getElementById('funcionarioInfoInventario');
      const leitura=document.getElementById('leituraInfoInventario');
      info.classList.remove('hidden');
      leitura.classList.remove('hidden');
      info.innerHTML=`<div class="grid grid-cols-1 gap-2"><div><strong>üìã Matr√≠cula:</strong> ${currentFuncionario.id}</div><label class="text-sm text-gray-700 mt-1"><strong>üë§ Nome:</strong></label><input id="nomeFuncionarioInventario" class="w-full px-3 py-2 border border-green-300 rounded-lg" placeholder="Digite o nome" /><div><strong>üè¢ Setor:</strong> ${currentFuncionario.setor}</div></div>`;
      const dataLeitura=currentFuncionario.dataLeitura||new Date();
      leitura.innerHTML=`<div><strong>üïê Leitura:</strong> ${new Date(dataLeitura).toLocaleString('pt-BR')}</div>`;
    }

    // ============ OBJETOS LOCAIS ============
    function loadObjetosDisponiveis(){
      const select=document.getElementById('objetoRetirada');
      select.innerHTML='<option value="">Selecione um objeto...</option>';
      (LOCAL_OBJETOS[currentSetor]||[]).forEach(nome=>{ const o=document.createElement('option'); o.value=nome; o.textContent=nome; select.appendChild(o); });
    }

    function prepararInventario(){
      const container=document.getElementById('listaObjetosInventario');
      const statusDiv=document.getElementById('statusObjetosInventario');
      const actionsDiv=document.getElementById('inventarioActions');
      container.innerHTML='';
      const lista=(LOCAL_OBJETOS[currentSetor]||[]);
      if(lista.length===0){
        container.innerHTML='<p class="text-gray-500 text-center py-4">Nenhum objeto configurado localmente para este setor. Edite <span class="font-mono">LOCAL_OBJETOS</span> no c√≥digo.</p>';
        statusDiv.classList.remove('hidden');
        actionsDiv.classList.add('hidden');
        return;
      }
      statusDiv.classList.remove('hidden');
      actionsDiv.classList.remove('hidden');
      lista.forEach((nome, idx)=>{
        const id='inv_'+idx;
        const row=document.createElement('div');
        row.className='flex items-center justify-between p-3 border border-gray-200 rounded-lg';
        row.innerHTML = `<div class="font-semibold text-gray-800">${nome}</div>
          <div class="flex items-center space-x-4">
            <label class="inline-flex items-center space-x-1 text-sm"><input type="radio" name="${id}" value="Devolvido" checked class="text-purple-600" /><span>Devolvido</span></label>
            <label class="inline-flex items-center space-x-1 text-sm"><input type="radio" name="${id}" value="Em Uso" class="text-purple-600" /><span>Em Uso</span></label>
          </div>`;
        row.dataset.objeto=nome; row.dataset.group=id; container.appendChild(row);
      });
    }

    // ============ ENVIO AO FORMS (ATUALIZADO) ============
    async function postToForms({ objeto, matricula, funcionario, setor, status }){
      if(!GOOGLE_FORM_URL.includes('/formResponse')){ throw new Error('GOOGLE_FORM_URL inv√°lida'); }
      const params=new URLSearchParams();
      params.append('fvv','1');
      params.append('pageHistory','0');
      params.append(FORMS_FIELDS.objeto, (objeto||'').trim());
      params.append(FORMS_FIELDS.matricula, (matricula||'').trim());
      params.append(FORMS_FIELDS.funcionario, (funcionario||'').trim());
      params.append(FORMS_FIELDS.setor, (setor||'').trim());
      params.append(FORMS_FIELDS.timestamp, new Date().toISOString());
      params.append(FORMS_FIELDS.status, status); // Envia "Em Uso" OU "Devolvido"

      await fetch(GOOGLE_FORM_URL, {
        method:'POST',
        mode:'no-cors',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString()
      });
    }

    function confirmarRetirada(){
      const objSel=(document.getElementById('objetoRetirada').value||'').trim();
      const objManual=(document.getElementById('objetoRetiradaManual').value||'').trim();
      const objeto= objManual || objSel;
      if(!objeto){ showToast('Selecione ou digite o objeto','error'); return; }
      if(!currentFuncionario){ showToast('Identifique o funcion√°rio primeiro','error'); return; }
      const nome=(document.getElementById('nomeFuncionarioRetirada')?.value||'').trim();
      showConfirm(`Confirma a retirada do objeto "${objeto}"?`, async ()=>{
        try{
          await postToForms({ objeto, matricula: currentFuncionario.id, funcionario: nome, setor: currentSetor, status: STATUS_LABELS.emUso });
          showToast('Retirada registrada com sucesso!','success');
          currentFuncionario=null;
          document.getElementById('funcionarioInfoRetirada').classList.add('hidden');
          document.getElementById('leituraInfoRetirada').classList.add('hidden');
          document.getElementById('objetoSelectionRetirada').classList.add('hidden');
          document.getElementById('codigoManualRetirada').value='';
          document.getElementById('objetoRetiradaManual').value='';
          resetScanner('scannerRetirada','retirada');
          setTimeout(()=>showScreen('mainMenu'),800);
        }catch(err){ showToast('Falha ao enviar ao Forms: '+err.message,'error'); }
      });
    }

    function confirmarDevolucao(){
      const objeto=(document.getElementById('objetoDevolucao').value||'').trim();
      const mat=(document.getElementById('matriculaDevolucao').value||'').trim(); // opcional
      if(!objeto){ showToast('Informe o nome do objeto','error'); return; }
      showConfirm(`Confirma a devolu√ß√£o do objeto "${objeto}"?`, async ()=>{
        try{
          await postToForms({ objeto, matricula: mat, funcionario: '', setor: currentSetor, status: STATUS_LABELS.devolvido });
          showToast('Devolu√ß√£o registrada com sucesso!','success');
          document.getElementById('objetoDevolucao').value='';
          document.getElementById('matriculaDevolucao').value='';
          setTimeout(()=>showScreen('mainMenu'),800);
        }catch(err){ showToast('Falha ao enviar ao Forms: '+err.message,'error'); }
      });
    }

    async function finalizarInventario(){
      if(!currentFuncionario){ showToast('Identifique o funcion√°rio primeiro','error'); return; }
      const nome=(document.getElementById('nomeFuncionarioInventario')?.value||'').trim();
      const linhas=Array.from(document.querySelectorAll('#listaObjetosInventario > div'));
      if(linhas.length===0){ showToast('Nenhum objeto para inventariar','error'); return; }
      showConfirm('Confirma a finaliza√ß√£o do invent√°rio e envio dos status ao Forms?', async ()=>{
        try{
          const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
          for(const row of linhas){
            const objeto=row.dataset.objeto;
            const group=row.dataset.group;
            const checked=document.querySelector(`input[name="${group}"]:checked`);
            const status= checked? checked.value : STATUS_LABELS.devolvido; // default
            await postToForms({ objeto, matricula: currentFuncionario.id, funcionario: nome, setor: currentSetor, status });
            await sleep(300);
          }
          showToast('Invent√°rio enviado com sucesso!','success');
          currentFuncionario=null;
          document.getElementById('funcionarioInfoInventario').classList.add('hidden');
          document.getElementById('leituraInfoInventario').classList.add('hidden');
          document.getElementById('statusObjetosInventario').classList.add('hidden');
          document.getElementById('inventarioActions').classList.add('hidden');
          document.getElementById('codigoManualInventario').value='';
          resetScanner('scannerInventario','inventario');
          setTimeout(()=>showScreen('mainMenu'),800);
        }catch(err){ showToast('Falha ao enviar ao Forms: '+err.message,'error'); }
      });
    }

    // ============ MODAL ============
    let confirmCallback=null;
    function showConfirm(message, callback){
      const modal=document.getElementById('confirmModal');
      const msg=document.getElementById('confirmMessage');
      const btn=document.getElementById('confirmButton');
      msg.textContent=message; modal.classList.remove('hidden'); confirmCallback=callback;
      btn.onclick=function(){ modal.classList.add('hidden'); if(confirmCallback){ confirmCallback(); confirmCallback=null; } }
    }
    function cancelConfirm(){ document.getElementById('confirmModal').classList.add('hidden'); confirmCallback=null; }

    function voltarMenu(){
      Object.keys(qrScanners).forEach(ctx=>{ if(scannerActive[ctx]){ stopScanner(ctx); } });
      currentFuncionario=null;
      document.getElementById('codigoManualRetirada').value='';
      document.getElementById('codigoManualInventario').value='';
      document.getElementById('funcionarioInfoRetirada').classList.add('hidden');
      document.getElementById('leituraInfoRetirada').classList.add('hidden');
      document.getElementById('objetoSelectionRetirada').classList.add('hidden');
      document.getElementById('funcionarioInfoInventario').classList.add('hidden');
      document.getElementById('leituraInfoInventario').classList.add('hidden');
      document.getElementById('statusObjetosInventario').classList.add('hidden');
      document.getElementById('inventarioActions').classList.add('hidden');
      showScreen('mainMenu');
    }

    // ============ BOOT ============
    window.addEventListener('DOMContentLoaded', ()=>{ loadSetores(); initializeScanner('scannerRetirada','retirada'); initializeScanner('scannerInventario','inventario'); });
  </script>
</body>
</html>
