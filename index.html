<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KnifeControl Usu√°rio ‚Äî Fallback Google Forms (Sync)</title>
  <link rel="icon" type="image/png" href="https://pfst.cf2.poecdn.net/base/image/66a86ff2e9d405ae0301524bd658a3243a0dd6b3e9b05bb2cf53c4d11af08062?w=71&h=69" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <style>
    body { box-sizing: border-box; margin: 0; padding: 0; }
    .app-header { background: white; border-bottom: 2px solid #e5e7eb; padding: 8px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .app-header img { height: 50px; width: auto; display: block; margin: 0 auto; }

    .scanner-container { position: relative; width: 100%; height: 260px; background: #000; border: 2px solid #3b82f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; overflow: hidden; }
    .scanner-container:hover { border-color: #1d4ed8; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    .scanner-container video { width: 100%; height: 100%; object-fit: cover; }
    .scanner-inactive { background: linear-gradient(45deg, #f3f4f6, #e5e7eb); border: 2px dashed #9ca3af; }
    .scanner-inactive:hover { border-color: #3b82f6; background: linear-gradient(45deg, #eff6ff, #dbeafe); }

    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
  </style>

<script>
window.addEventListener('DOMContentLoaded', function(){
  setTimeout(function(){
    if (typeof window.Html5Qrcode !== 'function'){
      var s=document.createElement('script'); s.id='fallbackHtml5Qrcode';
      s.src='https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js'; s.async=true;
      document.head.appendChild(s);
    }
  }, 500);
});
</script>
</head>
<body class="bg-gray-100">

  <div class="app-header">
    <img src="https://pfst.cf2.poecdn.net/base/image/b4c6aca4c7db7589b9f0de13c8ee90d92d0ff180d82b105e4e1961cae846d611?w=225&h=92" alt="LSG Sky Chefs" />
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="bg-white rounded-2xl shadow-2xl p-8">
        <div class="text-center mb-6">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">üî™ KnifeControl</h1>
          <p class="text-gray-600 mt-2">Sistema de Controle de Objetos ‚Äî <span class="font-semibold">Modo Fallback (Google Forms)</span></p>
        </div>
        <form id="loginForm" class="space-y-6">
          <div>
            <label for="setor" class="block text-sm font-medium text-gray-700 mb-2">Setor</label>
            <select id="setor" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Carregando setores...</option>
            </select>
          </div>
          <div>
            <label for="senha" class="block text-sm font-medium text-gray-700 mb-2">Senha do setor</label>
            <input type="password" id="senha" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Digite a senha do setor" />
          </div>
          <div id="connectionStatus" class="text-center text-sm text-green-600">‚úÖ Conectado (Fallback Google Forms)</div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg">Entrar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- MENU -->
  <div id="mainMenu" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <div class="text-center">
          <h2 class="text-xl font-bold text-gray-800">Bem-vindo!</h2>
          <p class="text-gray-600" id="setorAtual">Setor: </p>
          <div class="mt-2 text-xs text-green-600 flex items-center justify-content-center">
            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
            <span id="syncStatus">Sincronizando status com planilha do Forms‚Ä¶</span>
          </div>
        </div>
      </div>
      <div class="space-y-4">
        <button onclick="showScreen('retiradaScreen')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üì§</div>
          <div class="text-xl font-bold">Retirada de Objeto</div>
          <div class="text-sm opacity-90 mt-1">Registrar retirada (marca como <b>Em Uso</b>)</div>
        </button>
        <button onclick="showScreen('devolucaoScreen')" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üì•</div>
          <div class="text-xl font-bold">Devolu√ß√£o de Objeto</div>
          <div class="text-sm opacity-90 mt-1">Devolver apenas itens <b>Em Uso</b> no seu setor</div>
        </button>
        <button onclick="showScreen('inventarioScreen')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üìã</div>
          <div class="text-xl font-bold">Invent√°rio de Fim de Turno</div>
          <div class="text-sm opacity-90 mt-1">Bloqueia se houver itens <b>Em Uso</b></div>
        </button>
        <button onclick="logout()" class="w-full bg-gray-200 text-gray-700 p-4 rounded-xl hover:bg-gray-300 transition duration-300 mt-4">
          <div class="text-sm font-semibold">üö™ Sair</div>
        </button>
      </div>
    </div>
  </div>

  <!-- RETIRADA -->
  <div id="retiradaScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üì§</span> Retirada de Objeto
        </h2>

        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-gray-600">Ler QR do crach√° ou digitar a matr√≠cula</div>
          <button type="button" class="px-3 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700" onclick="startScanner('retirada')">Ler QR</button>
        </div>
        <div id="scannerRetirada" class="scanner-container scanner-inactive mb-2"></div>
        <div id="scanStatus-retirada" class="hidden mb-4 p-3 rounded-lg text-center font-semibold"></div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">Matr√≠cula</label>
          <div class="flex space-x-2">
            <input type="text" id="codigoManualRetirada" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="C√≥digo / Matr√≠cula" />
            <button onclick="identificarManual('retirada')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Identificar</button>
          </div>
        </div>

        <div id="funcionarioInfoRetirada" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-4 mb-4"></div>
        <div id="leituraInfoRetirada" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-gray-700"></div>

        <div id="objetoSelectionRetirada" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Objeto:</label>
          <select id="objetoRetirada" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3">
            <option value="">Selecione um objeto...</option>
          </select>
          <div class="text-xs text-gray-500 mb-3">Se n√£o encontrar na lista, digite abaixo:</div>
          <input type="text" id="objetoRetiradaManual" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Nome do objeto" />
          <button onclick="confirmarRetirada()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300">Confirmar Retirada</button>
        </div>
        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- DEVOLU√á√ÉO -->
  <div id="devolucaoScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üì•</span> Devolu√ß√£o de Objeto
        </h2>

        <div id="devolucaoLista" class="grid grid-cols-2 gap-2 mb-2"></div>
        <div id="devolucaoEmpty" class="hidden text-gray-500 text-sm p-3 border rounded-lg">Nenhum objeto em uso neste setor.</div>

        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- INVENT√ÅRIO -->
  <div id="inventarioScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="mr-2">üìã</span> Invent√°rio de Fim de Turno
        </h2>

        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-gray-600">Ler QR do crach√° ou digitar a matr√≠cula</div>
          <button type="button" class="px-3 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700" onclick="startScanner('inventario')">Ler QR</button>
        </div>
        <div id="scannerInventario" class="scanner-container scanner-inactive mb-2"></div>
        <div id="scanStatus-inventario" class="hidden mb-4 p-3 rounded-lg text-center font-semibold"></div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">Matr√≠cula</label>
          <div class="flex space-x-2">
            <input type="text" id="codigoManualInventario" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="C√≥digo / Matr√≠cula" />
            <button onclick="identificarManual('inventario')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Identificar</button>
          </div>
        </div>

        <div id="funcionarioInfoInventario" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-4 mb-4"></div>
        <div id="leituraInfoInventario" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-gray-700"></div>

        <div id="statusObjetosInventario" class="hidden mb-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Status dos Objetos do Setor:</h3>
          <div id="listaObjetosInventario" class="space-y-2"></div>
        </div>

        <div id="inventarioActions" class="hidden">
          <button id="btnFinalizarInventario" onclick="finalizarInventario()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">Finalizar Invent√°rio</button>
          <div id="inventarioAviso" class="text-sm text-red-600 mt-2 hidden">‚ö†Ô∏è H√° objetos em uso. Finaliza√ß√£o bloqueada.</div>
        </div>

        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- CONFIRM -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all">
      <div class="text-center mb-6">
        <div class="text-4xl mb-3" id="confirmIcon">‚ùì</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2" id="confirmTitle">Confirmar A√ß√£o</h3>
        <p class="text-gray-600" id="confirmMessage"></p>
      </div>
      <div class="flex space-x-3">
        <button onclick="cancelConfirm()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300">N√£o</button>
        <button id="confirmButton" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Sim</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="hidden fixed top-20 right-4 z-50 max-w-sm">
    <div id="toastContent" class="rounded-xl shadow-2xl p-4 transform transition-all"></div>
  </div>

  <script>
    // =================== CONFIG ===================
    const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScKBnRZ2StGX5qIqGVPrsXbt-hTbTawDYWqR3iEELCq9of7Xw/formResponse';
    const FORMS_FIELDS = {
      objeto: 'entry.587663124', matricula: 'entry.360956002', funcionario: 'entry.245251034', setor: 'entry.431322508', timestamp: 'entry.2072805918', emUso: 'entry.1169418597', devolvido: 'entry.2075298705'
    };
    const CHECKBOX_LABELS = { emUso: 'Em Uso', devolvido: 'Devolvido' };

    // üëâ Configure aqui sua planilha de respostas (Google Sheets) publicada para web
    // Use o formato GViz JSON (Visualization API):
    //   https://docs.google.com/spreadsheets/d/SEU_SHEET_ID/gviz/tq?tqx=out:json&sheet=NomeDaAba
    // A aba deve ser a que cont√©m as respostas do Google Forms.
    const FORMS_RESP_GVIS_URL = 'https://docs.google.com/spreadsheets/d/1k3K5NBme5EklfF4o_yfSCJzTSXrXFA2AKdFFvnkeMcE/gviz/tq?tqx=out:json&gid=324654921'; // TODO: Substituir

    // Funcion√°rios e objetos locais
    const EMPLOYEE_JSON_URL = '/planilha.json'; // sua base (funcionarios + setores + objetos + senhas)

    // Se n√£o houver planilha.json acess√≠vel, estes ser√£o o fallback
    const LOCAL_FUNCIONARIOS = [
      { matricula: '10001', nome: 'Jo√£o Silva', setor: 'Padaria' },
      { matricula: '10002', nome: 'Maria Souza', setor: 'A√ßougue' },
      { matricula: '10003', nome: 'Carlos Pereira', setor: 'Coc√ß√£o' },
      { matricula: '10004', nome: 'Ana Lima', setor: 'Confeitaria' },
      { matricula: '10005', nome: 'Vitor Teste', setor: 'Teste' }
    ];
    const LOCAL_SETORES = ['Teste','A√ßougue','Coc√ß√£o','Confeitaria','Corte de Frios','Ensacamento de P√£es','Gard Manger','Padaria','Pr√©-Preparo','Montagem de Sandu√≠ches'];
    const LOCAL_OBJETOS = {
      'Teste': ['FACA TESTE'],
      'A√ßougue': ['95 ‚Äì FACA','100 ‚Äì FACA','107 ‚Äì FACA','108 ‚Äì FACA'],
      'Coc√ß√£o': ['45 ‚Äì FACA','51 ‚Äì FACA','52 ‚Äì FACA','53 ‚Äì FACA'],
      'Confeitaria': ['72 ‚Äì FACA','73 ‚Äì FACA','74 ‚Äì FACA'],
      'Corte de Frios': ['32 ‚Äì FACA','33 ‚Äì FACA'],
      'Ensacamento de P√£es': ['20 ‚Äì FACA','66 ‚Äì FACA'],
      'Gard Manger': ['02 ‚Äì TESOURA','17 ‚Äì FACA','18 ‚Äì FACA','44 ‚Äì FACA','45 ‚Äì FACA','48 ‚Äì FACA','49 ‚Äì FACA'],
      'Montagem de Sandu√≠ches': ['60 ‚Äì FACA','61 ‚Äì FACA','62 ‚Äì FACA','63 ‚Äì FACA','64 ‚Äì FACA','65 ‚Äì FACA','66 ‚Äì TESOURA'],
      'Padaria': ['88 ‚Äì FACA','89 ‚Äì FACA','0028199 ‚Äì ESTILETE','0028200 ‚Äì ESTILETE'],
      'Pr√©-Preparo': ['84 ‚Äì FACA','85 ‚Äì FACA','86 ‚Äì FACA','87 ‚Äì FACA','89 ‚Äì FACA','90 ‚Äì FACA','91 ‚Äì TESOURA']
    };

    const ENFORCE_LOCAL_PASSWORD = true;
    const LOCAL_SENHAS = { 'Produ√ß√£o':'1234','Cozinha Quente':'1234','Cozinha Fria':'1234','Expedi√ß√£o':'1234','Teste':'a','A√ßougue':'acougue','Coc√ß√£o':'coccao','Confeitaria':'confeitaria','Corte de Frios':'frios','Ensacamento de P√£es':'ensacamento','Gard Manger':'gard','Padaria':'padaria','Pr√©-Preparo':'preparo','Montagem de Sandu√≠ches':'montagem' };

    // =================== ESTADO ===================
    let currentSetor = '';
    let currentFuncionario = null; // { id, nome, setor, dataLeitura }
    let qrScanners = {}; let scannerActive = {};

    let FUNCIONARIOS = [];
    let OBJETOS = LOCAL_OBJETOS;
    let SETORES = LOCAL_SETORES;

    // STATUS remoto (vindos da planilha-resposta do Forms) por setor/objeto
    // Estrutura: { [setor]: { [objeto]: 'Em Uso'|'Devolvido' } }
    let REMOTE_STATUS = {};

    // =================== UTIL ===================
    const STORAGE_KEY = 'KC_STATUS_V1';
    function loadStatus(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(e){ return {}; } }
    function saveStatus(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

    function getSectorStatusLocal(setor){ const db=loadStatus(); return db[setor]||{}; }
    function setObjectStatusLocal(setor, objeto, status){ const db=loadStatus(); if(!db[setor]) db[setor]={}; db[setor][objeto] = { status, ts: new Date().toISOString() }; saveStatus(db); }

    function getMergedStatus(setor){
      // REMOTE (autoridade) > LOCAL (interino)
      const remote = REMOTE_STATUS[setor] || {};
      const local = getSectorStatusLocal(setor);
      const merged = { ...local, ...remote };
      return merged; // { objeto: {status, ts?} ou 'status' string } ‚Äî normalizamos ao ler
    }

    function normalize(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
    function getNomeByMatricula(m){ const f = FUNCIONARIOS.find(x=> String(x.matricula)===String(m)); return f? f.nome : ''; }
    function getMatriculaByNome(n){ const N=normalize(n); const f = FUNCIONARIOS.find(x=> normalize(x.nome)===N); return f? String(f.matricula):''; }

    function setSyncStatus(msg, ok=true){ const el=document.getElementById('syncStatus'); if(!el) return; el.textContent = (ok? '‚úÖ ' : '‚ö†Ô∏è ') + msg; el.className = ok? 'text-green-600' : 'text-yellow-700'; }

    // =================== CARREGAMENTO DE BASE ===================
    async function loadEmployeesAndConfig(){
      try{
        const resp = await fetch(EMPLOYEE_JSON_URL, { cache:'no-store' });
        if(resp.ok){ const j = await resp.json();
          if(Array.isArray(j.funcionarios)) FUNCIONARIOS = j.funcionarios; else FUNCIONARIOS = LOCAL_FUNCIONARIOS;
          if(j.objetos && typeof j.objetos==='object') OBJETOS = j.objetos; else OBJETOS = LOCAL_OBJETOS;
          if(Array.isArray(j.setores)) SETORES = j.setores; else SETORES = LOCAL_SETORES;
        } else { FUNCIONARIOS = LOCAL_FUNCIONARIOS; OBJETOS = LOCAL_OBJETOS; SETORES = LOCAL_SETORES; }
      }catch(e){ FUNCIONARIOS = LOCAL_FUNCIONARIOS; OBJETOS = LOCAL_OBJETOS; SETORES = LOCAL_SETORES; }
    }

    // =================== LER PLANILHA-RESPOSTA (GViz JSON) ===================
    async function refreshRemoteStatus(){
      if(!FORMS_RESP_GVIS_URL || FORMS_RESP_GVIS_URL.startsWith('COLE_AQUI')){ setSyncStatus('Configure a URL da planilha do Forms em GViz JSON', false); return; }
      try{
        const resp = await fetch(FORMS_RESP_GVIS_URL, { cache:'no-store' });
        if(!resp.ok){ setSyncStatus('Falha ao acessar planilha do Forms ('+resp.status+')', false); return; }
        const txt = await resp.text();
        // Remove prefix/sufixo do GViz: /*O_o*/ google.visualization.Query.setResponse(...);
        const jsonStr = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1);
        const gviz = JSON.parse(jsonStr);
        const cols = (gviz.table.cols||[]).map(c=>c.label?.trim());
        const rows = gviz.table.rows||[];

        // Esperado: colunas com r√≥tulos do seu Form (ajuste aqui se necess√°rio)
        // Ex: Objeto, Matr√≠cula, Funcion√°rio, Setor, Timestamp, Em Uso, Devolvido
        const idx = {
          objeto: cols.findIndex(x=> /objeto/i.test(x||'')),
          matricula: cols.findIndex(x=> /matr[i√≠]cula/i.test(x||'')),
          funcionario: cols.findIndex(x=> /funcion[√°a]rio/i.test(x||'')),
          setor: cols.findIndex(x=> /setor/i.test(x||'')),
          timestamp: cols.findIndex(x=> /timestamp|data|hora/i.test(x||'')),
          emUso: cols.findIndex(x=> /em\s*uso/i.test(x||'')),
          devolvido: cols.findIndex(x=> /devolvid/i.test(x||''))
        };

        const records = rows.map(r=>{
          const c = r.c||[];
          const get = i => (i>=0 && c[i] && c[i].v!=null) ? String(c[i].v) : '';
          return {
            objeto: get(idx.objeto).trim(),
            matricula: get(idx.matricula).trim(),
            funcionario: get(idx.funcionario).trim(),
            setor: get(idx.setor).trim(),
            timestamp: get(idx.timestamp).trim(),
            emUso: /em\s*uso/i.test(get(idx.emUso)),
            devolvido: /devolvid/i.test(get(idx.devolvido))
          };
        }).filter(r=>r.objeto && r.setor);

        // Reduce: √∫ltimo status por setor/objeto baseado no timestamp
        const byKey = {}; // key = setor||objeto
        for(const r of records){
          const key = r.setor+'\u0001'+r.objeto;
          const ts = Date.parse(r.timestamp) || 0;
          if(!byKey[key] || ts > byKey[key].ts){
            byKey[key] = { status: r.devolvido? 'Devolvido' : (r.emUso? 'Em Uso' : 'Devolvido'), ts };
          }
        }
        // Preenche REMOTE_STATUS
        REMOTE_STATUS = {};
        Object.entries(byKey).forEach(([key, val])=>{
          const [setor, objeto] = key.split('\u0001');
          if(!REMOTE_STATUS[setor]) REMOTE_STATUS[setor] = {};
          REMOTE_STATUS[setor][objeto] = val; // {status, ts}
        });
        setSyncStatus('Status sincronizado com a planilha do Forms');
      }catch(e){ console.error(e); setSyncStatus('Erro ao ler GViz JSON do Forms', false); }
    }

    // =================== TOAST ===================
    function showToast(message, type='success'){
      const toast=document.getElementById('toast'); const toastContent=document.getElementById('toastContent');
      const bg= type==='success'?'bg-green-500':'bg-red-500'; const icon= type==='success'?'‚úÖ':'‚ùå';
      toastContent.className=`rounded-xl shadow-2xl p-4 text-white ${bg}`;
      toastContent.innerHTML=`<div class=\"flex items-center space-x-3\"><div class=\"text-2xl\">${icon}</div><div class=\"flex-1 font-semibold\">${message}</div></div>`;
      toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'),3200);
    }

    // =================== LOGIN & SETORES ===================
    function loadSetores(){ const setorSelect=document.getElementById('setor'); setorSelect.innerHTML='<option value=\"\">Selecione um setor...</option>'; (SETORES||LOCAL_SETORES).forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; setorSelect.appendChild(opt); }); }

    document.getElementById('loginForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const setor=document.getElementById('setor').value; const senha=document.getElementById('senha').value;
      if(!setor||!senha){ showToast('Por favor, preencha todos os campos','error'); return; }
      if(ENFORCE_LOCAL_PASSWORD){ if(!LOCAL_SENHAS[setor] || LOCAL_SENHAS[setor]!==senha){ showToast('Senha incorreta','error'); return; } }
      currentSetor=setor; document.getElementById('setorAtual').textContent='Setor: '+currentSetor;
      showScreen('mainMenu'); showToast('Login realizado com sucesso!','success');
      // Ap√≥s login, sincroniza status remoto
      refreshRemoteStatus();
    });

    function logout(){ Object.keys(qrScanners).forEach(ctx=>{ if(qrScanners[ctx]){ qrScanners[ctx].stop().catch(()=>{}); }}); currentSetor=''; currentFuncionario=null; document.getElementById('senha').value=''; document.getElementById('setor').value=''; showScreen('loginScreen'); }

    // =================== NAVEGA√á√ÉO ===================
    function showScreen(id){
      ['loginScreen','mainMenu','retiradaScreen','devolucaoScreen','inventarioScreen'].forEach(s=>document.getElementById(s).classList.add('hidden'));
      const el=document.getElementById(id); el.classList.remove('hidden'); el.classList.add('fade-in');
      if(id==='retiradaScreen'){ loadObjetosDisponiveis(); resetScanner('scannerRetirada','retirada'); bindMatriculaAutoFill('retirada'); }
      if(id==='devolucaoScreen'){ montarListaDevolucao(); }
      if(id==='inventarioScreen'){ resetScanner('scannerInventario','inventario'); bindMatriculaAutoFill('inventario'); montarInventario(); }
    }

    // =================== QR CODE ===================
    function ensureSecure(){ if(location.protocol!=='https:' && location.hostname!=='localhost'){ showToast('Para abrir a c√¢mera, use HTTPS (requisito do navegador).','error'); return false; } return true; }

    function initializeScanner(containerId, context){
      const container=document.getElementById(containerId);
      resetScanner(containerId, context);
      container.onclick = ()=> startScanner(context);
    }

    async function startScanner(context){
      if(!ensureSecure()) return;
      const containerId = (context==='retirada'?'scannerRetirada':'scannerInventario');
      const container = document.getElementById(containerId);
      try{
        container.innerHTML='<div id="qr-reader-'+context+'" style="width: 100%; height: 100%"></div>'; container.classList.remove('scanner-inactive');
        const scanner=new Html5Qrcode('qr-reader-'+context); qrScanners[context]=scanner;
        await scanner.start({facingMode:'environment'},{fps:10, qrbox:{width:240, height:240}}, (decodedText)=>{ processQRCode(decodedText, context); stopScanner(context); }, (error)=>{});
        scannerActive[context]=true; updateScanStatus(context, 'üì∑ C√¢mera ativa ‚Äî Aponte para o QR Code', 'loading');
      }catch(err){ console.error('Erro ao iniciar scanner:', err); updateScanStatus(context,'‚ùå Erro ao acessar c√¢mera','error'); resetScanner(containerId, context); }
    }

    function stopScanner(context){ if(qrScanners[context]){ qrScanners[context].stop().then(()=>{ scannerActive[context]=false; const containerId=(context==='retirada'?'scannerRetirada':'scannerInventario'); resetScanner(containerId, context); }).catch(()=>{}); } }
    function resetScanner(containerId, context){ const c=document.getElementById(containerId); if(!c) return; c.classList.add('scanner-inactive'); c.innerHTML=`<div class="text-center text-gray-600 p-4"><div class="text-4xl mb-2">üì∑</div><div class="font-semibold">Toque ou use o bot√£o "Ler QR"</div><div class="text-sm mt-1">ou digite a matr√≠cula abaixo</div></div>`; const st=document.getElementById('scanStatus-'+context); if(st){ st.classList.add('hidden'); st.textContent=''; } }
    function updateScanStatus(context, message, type){ const el=document.getElementById('scanStatus-'+context); if(!el) return; el.classList.remove('hidden','bg-blue-100','bg-green-100','bg-red-100','text-blue-700','text-green-700','text-red-700'); if(type==='loading'){ el.classList.add('bg-blue-100','text-blue-700'); } else if(type==='active'){ el.classList.add('bg-green-100','text-green-700'); } else if(type==='error'){ el.classList.add('bg-red-100','text-red-700'); } el.textContent=message; }

    function bindMatriculaAutoFill(context){
      const inputId = context==='retirada' ? 'codigoManualRetirada' : 'codigoManualInventario';
      const el = document.getElementById(inputId); if(!el) return;
      el.addEventListener('input', ()=> autoFillNomeFromMatricula(context));
      el.addEventListener('blur',  ()=> autoFillNomeFromMatricula(context));
    }

    function parseCrachaData(raw){
  const txt = String(raw || '').trim();
  const justDigits = txt.replace(/\D+/g, '');
  if (justDigits && /^\d+$/.test(justDigits)) { return { matricula: justDigits, nome: '' }; }
  try{ const o = JSON.parse(txt); return { matricula: o.matricula ? String(o.matricula) : '', nome: o.nome || '' }; }catch(e){}
  const r1 = txt.match(/^\s*(\d+)\s*[|;,\t]\s*(.+)\s*$/); if(r1) return { matricula:r1[1], nome:r1[2] };
  const r2 = txt.match(/matr[i√≠]cula[:=]\s*(\d+).*?(?:nome)[:=]\s*([^\n]+)/i); if(r2) return { matricula:r2[1], nome:r2[2] };
  return { matricula:'', nome: txt };
}


// =================== BOOT ===================
    async function boot(){
      await loadEmployeesAndConfig();
      loadSetores();
      initializeScanner('scannerRetirada','retirada');
      initializeScanner('scannerInventario','inventario');
      // Sincroniza periodicamente (caso a planilha demore para atualizar)
      setInterval(()=>{ if(currentSetor) refreshRemoteStatus(); }, 15000);
    }
    window.addEventListener('DOMContentLoaded', boot);
  </script>

<script>
// --- Overrides (scanner + identifica√ß√£o manual + parser QR) ---
function ensureSecure(){
  const isSecure = (location.protocol === 'https:' || location.hostname === 'localhost');
  if (!isSecure) { showToast('Para abrir a c√¢mera, use HTTPS (ou localhost).', 'error'); }
  return isSecure;
}
async function startScanner(context){
  if(!ensureSecure()) return;
  if (typeof window.Html5Qrcode !== "function") {
    showToast("Leitor de QR n√£o carregou. Recarregue a p√°gina (CTRL+F5).", "error");
    console.error("Html5Qrcode n√£o dispon√≠vel. Verifique o script CDN.");
    return;
  }
  const containerId = (context==='retirada'?'scannerRetirada':'scannerInventario');
  const container = document.getElementById(containerId);
  try{
    container.innerHTML = '<div id="qr-reader-'+context+'" style="width: 100%; height: 100%"></div>';
    container.classList.remove('scanner-inactive');
    const constraints = { facingMode: { ideal: 'environment' } };
    const scanner = new Html5Qrcode('qr-reader-'+context);
    qrScanners[context] = scanner;
    await scanner.start(
      constraints,
      { fps: 10, qrbox: { width: 240, height: 240 } },
      (decodedText) => { processQRCode(decodedText, context); stopScanner(context); },
      (error) => { /* decode errors expected; ignore */ }
    );
    scannerActive[context] = true;
    updateScanStatus(context, 'üì∑ C√¢mera ativa ‚Äî Aponte para o QR Code', 'loading');
  }catch(err){
    console.error('Erro ao iniciar scanner:', err);
    updateScanStatus(context, '‚ùå Erro ao acessar c√¢mera (verifique permiss√µes/HTTPS).', 'error');
    resetScanner(containerId, context);
  }
}
async function identificarManual(context){
  const inputId = context==='retirada' ? 'codigoManualRetirada' : 'codigoManualInventario';
  const codigo = (document.getElementById(inputId).value || '').trim();
  if(!codigo){ showToast('Por favor, digite a matr√≠cula','error'); return; }
  const onlyDigits = codigo.replace(/\D+/g, '');
  if(!onlyDigits){ showToast('A matr√≠cula deve conter apenas n√∫meros.','error'); return; }
  const existe = FUNCIONARIOS.some(f => String(f.matricula) === String(onlyDigits));
  if(!existe){ showToast('Matr√≠cula n√£o cadastrada.','error'); return; }
  const nome = getNomeByMatricula(onlyDigits) || '';
  currentFuncionario = { id: onlyDigits, nome, setor: currentSetor, dataLeitura: new Date() };
  if(context==='retirada'){
    showFuncionarioInfo();
    const nomeEl = document.getElementById('nomeFuncionarioRetirada'); if(nome && nomeEl){ nomeEl.value = nome; }
    loadObjetosDisponiveis();
  } else {
    showFuncionarioInfoInventario();
    const nomeEl = document.getElementById('nomeFuncionarioInventario'); if(nome && nomeEl){ nomeEl.value = nome; }
    montarInventario();
  }
  updateScanStatus(context,'‚úÖ Funcion√°rio identificado','active');
  setTimeout(()=>{ const st=document.getElementById('scanStatus-'+context); if(st) st.classList.add('hidden'); },1800);
}
function parseCrachaData(raw){
  const txt = String(raw || '').trim();
  const justDigits = txt.replace(/\D+/g, '');
  if (justDigits && /^\d+$/.test(justDigits)) { return { matricula: justDigits, nome: '' }; }
  try{ const o = JSON.parse(txt); return { matricula: o.matricula ? String(o.matricula) : '', nome: o.nome || '' }; }catch(e){}
  const r1 = txt.match(/^\s*(\d+)\s*[|;,	]\s*(.+)\s*$/); if(r1) return { matricula:r1[1], nome:r1[2] };
  const r2 = txt.match(/matr[i√≠]cula[:=]\s*(\d+).*(nome)[:=]\s*([^
]+)/i); if(r2) return { matricula:r2[1], nome:r2[3] };
  return { matricula:'', nome: txt };
}
</script>

</body>
</html>
