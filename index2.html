<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KnifeControl Usu√°rio ‚Äî DEBUG (POST vis√≠vel ao Google Forms)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{box-sizing:border-box;margin:0;padding:0;background:#f5f7fb}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:9999px;font-size:12px}
    .badge-green{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .badge-red{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
  </style>
</head>
<body class="p-4">
  <div class="max-w-2xl mx-auto card p-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-1">KnifeControl ‚Äî DEBUG</h1>
    <p class="text-gray-600 mb-4">Esta vers√£o abre o retorno do Google Forms em <b>nova aba</b> e registra no Console o payload enviado.</p>

    <div id="status" class="mb-4 text-sm"><span class="badge">Carregando planilha.json...</span></div>

    <div class="grid gap-3" style="grid-template-columns: 1fr 1fr;">
      <div>
        <label class="block text-sm text-gray-700 mb-1">Setor (do objeto)</label>
        <select id="setor" class="w-full border rounded px-3 py-2 text-sm"></select>
      </div>
      <div>
        <label class="block text-sm text-gray-700 mb-1">Senha do setor</label>
        <input id="senha" type="password" class="w-full border rounded px-3 py-2 text-sm" placeholder="Senha" />
      </div>
    </div>
    <button id="btnLogin" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">Entrar</button>

    <hr class="my-5"/>

    <div id="areaAcoes" class="hidden">
      <div class="grid gap-3" style="grid-template-columns: 1fr 1fr;">
        <div>
          <label class="block text-sm text-gray-700 mb-1">Matr√≠cula</label>
          <input id="matricula" class="w-full border rounded px-3 py-2 text-sm" placeholder="Digite a matr√≠cula" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">Objeto</label>
          <select id="objeto" class="w-full border rounded px-3 py-2 text-sm"></select>
        </div>
      </div>
      <div class="flex gap-2 mt-3">
        <button id="btnRetirada" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded text-sm">Retirada</button>
        <button id="btnDevolucao" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm">Devolu√ß√£o</button>
        <button id="btnInventario" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm">Invent√°rio de Final de Turno</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Abra o Console (F12) para ver <code>console.table</code> com os dados enviados.</p>
    </div>
  </div>

  <!-- IFRAME apenas para refer√™ncia (N√ÉO usado no debug); mantido para compatibilidade visual -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

  <script>
  // ================== CONFIG ATUALIZADA (conforme instru√ß√µes do Vitor) ==================
  // Voc√™ forneceu o /viewform. Para POST externo, o endpoint correto √© /formResponse.
  const GOOGLE_FORM_VIEW_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScKBnRZ2StGX5qIqGVPrsXbt-hTbTawDYWqR3iEELCq9of7Xw/viewform';
  const GOOGLE_FORM_URL = GOOGLE_FORM_VIEW_URL.replace('/viewform','/formResponse');

  // Entrys v√°lidos e atuais:
  const FORMS_FIELDS = {
    tipoAcao:  'entry.2075298705', // Tipo de A√ß√£o (Resposta curta)
    matricula: 'entry.360956002',  // Matr√≠cula (Resposta curta)
    objeto:    'entry.587663124'   // Objeto (Resposta curta)
  };

  // Planilha de leitura (se desejar testar leitura depois):
  const SHEET_ID   = '1f-neTp_hpVn3wUdfiw5DuBmlsTGG4VlAcpni71EQAqI';
  const SHEET_TABS = ['Respostas ao formul√°rio 1'];

  // ================== Estado ==================
  let PLANILHA = { setores:[], setoresSenha:{}, objetos:{}, funcionarios:[] };
  let currentSetor = '';

  // ================== Utilidades ==================
  function setMsg(ok, msg){
    const el=document.getElementById('status');
    if(ok) el.innerHTML = `<span class="badge badge-green">${msg}</span>`;
    else   el.innerHTML = `<span class="badge badge-red">${msg}</span>`;
  }

  async function carregarJSON(){
    try{
      const res = await fetch('planilha.json', {cache:'no-store'});
      if(!res.ok) throw new Error('planilha.json n√£o encontrado');
      const j = await res.json(); PLANILHA = j||{};
      setMsg(true,'üìÑ planilha.json carregado');
      const sel=document.getElementById('setor');
      sel.innerHTML='';
      const lista = (PLANILHA.setores?.length? PLANILHA.setores : Object.keys(PLANILHA.objetos||{}));
      lista.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
    }catch(e){ setMsg(false,'‚ùå planilha.json n√£o encontrado'); console.error(e); }
  }

  document.getElementById('btnLogin').addEventListener('click', ()=>{
    const setor = document.getElementById('setor').value;
    const senha = document.getElementById('senha').value;
    const senhaEsperada = PLANILHA.setoresSenha?.[setor] || '';
    if(!setor){ setMsg(false,'Selecione um setor'); return; }
    if(String(senhaEsperada)!==String(senha)){ setMsg(false,'Senha do setor incorreta'); return; }
    currentSetor = setor;
    setMsg(true, '‚úÖ Login OK ‚Äî setor: '+setor);
    const sel=document.getElementById('objeto'); sel.innerHTML='';
    (PLANILHA.objetos?.[setor]||[]).forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
    document.getElementById('areaAcoes').classList.remove('hidden');
  });

  // ================== POST expl√≠cito (target _blank) e log do payload ==================
  function postToFormsDebug({ tipo, matricula, objeto }){
    const form=document.createElement('form');
    form.action = GOOGLE_FORM_URL;   // endpoint correto para POST
    form.method = 'POST';
    form.target = '_blank';          // <‚Äî DEBUG: abre retorno do Forms em nova aba

    const add=(name,val)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=name; i.value=val||''; form.appendChild(i); };
    add(FORMS_FIELDS.tipoAcao,  tipo||'');
    add(FORMS_FIELDS.matricula, String(matricula||''));
    add(FORMS_FIELDS.objeto,    objeto||'');
    // par√¢metros auxiliares que o Forms aceita; ajudam na compatibilidade
    add('fvv','1'); add('pageHistory','0'); add('fbzx', String(Math.random()).slice(2));

    // Log do payload (abra F12)
    console.table({ tipo, matricula:String(matricula||''), objeto, endpoint: form.action });

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }

  // Bot√µes
  document.getElementById('btnRetirada').addEventListener('click', ()=>{
    const m  = document.getElementById('matricula').value.trim();
    const obj= document.getElementById('objeto').value.trim();
    if(!m){ alert('Digite a matr√≠cula'); return; }
    if(!obj){ alert('Selecione o objeto'); return; }
    postToFormsDebug({ tipo:'Retirada', matricula:m, objeto:obj });
  });

  document.getElementById('btnDevolucao').addEventListener('click', ()=>{
    const m  = document.getElementById('matricula').value.trim();
    const obj= document.getElementById('objeto').value.trim();
    if(!m){ alert('Digite a matr√≠cula'); return; }
    if(!obj){ alert('Selecione o objeto'); return; }
    postToFormsDebug({ tipo:'Devolu√ß√£o', matricula:m, objeto:obj });
  });

  document.getElementById('btnInventario').addEventListener('click', ()=>{
    const m  = document.getElementById('matricula').value.trim();
    const obj= document.getElementById('objeto').value.trim();
    if(!m){ alert('Digite a matr√≠cula'); return; }
    if(!obj){ alert('Selecione o objeto'); return; }
    postToFormsDebug({ tipo:'Invent√°rio de Final de Turno', matricula:m, objeto:obj });
  });

  // Boot
  carregarJSON();
  </script>
</body>
</html>
