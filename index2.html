<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KnifeControl Usu√°rio ‚Äî Google Forms (sem campo Setor)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{box-sizing:border-box;margin:0;padding:0;background:#f5f7fb}
    .fade-in{animation:fadeIn .25s ease-in;}@keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:9999px;font-size:12px}
    .badge-green{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .badge-red{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .badge-yellow{background:#fffbeb;color:#92400e;border:1px solid #fde68a}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="bg-white rounded-2xl shadow-2xl p-8">
        <div class="text-center mb-6">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">üî™ KnifeControl</h1>
          <p class="text-gray-600 mt-2">Sistema de Controle ‚Äî <span class="font-semibold">Google Forms integrado</span></p>
        </div>
        <form id="loginForm" class="space-y-6">
          <div>
            <label for="setor" class="block text-sm font-medium text-gray-700 mb-2">Setor (do objeto)</label>
            <select id="setor" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Carregando setores...</option>
            </select>
          </div>
          <div>
            <label for="senha" class="block text-sm font-medium text-gray-700 mb-2">Senha do setor</label>
            <input type="password" id="senha" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Digite a senha do setor"/>
          </div>
          <div id="connectionStatus" class="text-center text-sm"><span class="badge">Carregando planilha.json...</span></div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg">Entrar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- MENU PRINCIPAL -->
  <div id="mainMenu" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <div class="text-center">
          <h2 class="text-xl font-bold text-gray-800">Bem-vindo!</h2>
          <p class="text-gray-600" id="setorAtual">Setor: </p>
        </div>
      </div>
      <div class="space-y-4">
        <button onclick="showScreen('retiradaScreen')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üì§</div>
          <div class="text-xl font-bold">Retirada de Objeto</div>
        </button>
        <button onclick="showScreen('devolucaoScreen')" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üì•</div>
          <div class="text-xl font-bold">Devolu√ß√£o de Objeto</div>
        </button>
        <button onclick="showScreen('inventarioScreen')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 transform hover:scale-105">
          <div class="text-4xl mb-2">üìã</div>
          <div class="text-xl font-bold">Invent√°rio de Fim de Turno</div>
        </button>
        <button onclick="enviarDiagnostico()" class="w-full bg-slate-800 text-white p-4 rounded-xl hover:bg-black transition duration-300">üß™ Enviar amostra ao Forms</button>
        <button onclick="lerStatusDiagnostico()" class="w-full bg-slate-200 text-slate-800 p-4 rounded-xl hover:bg-slate-300 transition duration-300">üîÑ Ler status agora</button>
        <button onclick="logout()" class="w-full bg-gray-200 text-gray-700 p-4 rounded-xl hover:bg-gray-300 transition duration-300 mt-2"><span class="text-sm font-semibold">üö™ Sair</span></button>
      </div>
    </div>
  </div>

  <!-- RETIRADA -->
  <div id="retiradaScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">üì§</span> Retirada de Objeto</h2>
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">Matr√≠cula do Funcion√°rio:</label>
          <input type="text" id="matriculaRetirada" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Digite a matr√≠cula" />
          <button onclick="identificarPorMatricula('retirada')" class="mt-2 w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Identificar</button>
        </div>
        <div id="funcionarioInfoRetirada" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-4 mb-4"></div>
        <div id="leituraInfoRetirada" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-gray-700"></div>
        <div id="objetoSelectionRetirada" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Objeto:</label>
          <select id="objetoRetirada" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4">
            <option value="">Selecione um objeto...</option>
          </select>
          <button onclick="confirmarRetirada()" class="mt-3 w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition dura√ß√£o-300">Confirmar Retirada</button>
        </div>
        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- DEVOLU√á√ÉO -->
  <div id="devolucaoScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">üì•</span> Devolu√ß√£o de Objeto</h2>
        <div id="listaDevolucao" class="space-y-2"></div>
        <p id="msgSemEmUso" class="hidden text-sm text-gray-500">N√£o h√° objetos em uso neste setor.</p>
        <button id="btnConfirmaDevolucao" onclick="confirmarDevolucao()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 mt-3 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed" disabled>Confirmar Devolu√ß√£o</button>
        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- INVENT√ÅRIO -->
  <div id="inventarioScreen" class="hidden min-h-full p-4">
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">üìã</span> Invent√°rio de Fim de Turno</h2>
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">Matr√≠cula do Funcion√°rio:</label>
          <input type="text" id="matriculaInventario" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Digite a matr√≠cula" />
          <button onclick="identificarPorMatricula('inventario')" class="mt-2 w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Identificar</button>
        </div>
        <div id="funcionarioInfoInventario" class="hidden bg-green-50 border-2 border-green-500 rounded-xl p-4 mb-4"></div>
        <div id="leituraInfoInventario" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-gray-700"></div>
        <div id="statusObjetosInventario" class="hidden mb-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Objetos do setor e status atual:</h3>
          <div id="listaObjetosInventario" class="space-y-2"></div>
          <div id="inventarioAviso" class="mt-2"></div>
        </div>
        <div id="inventarioActions" class="hidden">
          <button id="btnFinalizarInventario" onclick="finalizarInventario()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition dura√ß√£o-300 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed">Finalizar Invent√°rio</button>
        </div>
        <button onclick="voltarMenu()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300 mt-4">‚Üê Voltar ao Menu</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIRM -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all">
      <div class="text-center mb-6">
        <div class="text-4xl mb-3" id="confirmIcon">‚ùì</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2" id="confirmTitle">Confirmar A√ß√£o</h3>
        <p class="text-gray-600" id="confirmMessage"></p>
      </div>
      <div class="flex space-x-3">
        <button onclick="cancelConfirm()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-300">N√£o</button>
        <button id="confirmButton" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Sim</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="hidden fixed top-20 right-4 z-50 max-w-sm">
    <div id="toastContent" class="rounded-xl shadow-2xl p-4 transform transition-all"></div>
  </div>

  <!-- IFRAME oculto para post ao Forms -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

  <script>
  /* ======= CONFIG FORMS (sem campo Setor) ======= */
  const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScKBnRZ2StGX5qIqGVPrsXbt-hTbTawDYWqR3iEELCq9of7Xw/formResponse';
  const FORMS_FIELDS = {
    objeto:      'entry.587663124',
    matricula:   'entry.360956002',
    funcionario: 'entry.245251034',
    timestamp:   'entry.2072805918',
    tipoAcao:    'entry.2075298705',
    detalhe:     'entry.703890943'
  };

  /* ======= PLANILHA (para leitura de status) ======= */
  const SHEET_ID   = '1k7824Hngs2ztGzeenK2ZDfBebQOdTOCUQMOWNUpGwQY';
  const SHEET_TABS = ['Respostas ao formul√°rio 1'];

  /* ======= ESTADO ======= */
  let PLANILHA = { setores:[], setoresSenha:{}, objetos:{}, funcionarios:[] };
  let currentSetor = '';
  let currentFuncionario = null;
  let objetoSelecionadoDevolucao = null;
  let statusPorObjeto = {};

  /* ======= HELPERS ======= */
  function showToast(message, type='success'){
    const toast=document.getElementById('toast');
    const toastContent=document.getElementById('toastContent');
    const bg= type==='success' ? 'bg-green-500' : 'bg-red-500';
    const icon= type==='success'? '‚úÖ':'‚ùå';
    toastContent.className=`rounded-xl shadow-2xl p-4 text-white ${bg}`;
    toastContent.innerHTML=`<div class=\"flex items-center space-x-3\"><div class=\"text-2xl\">${icon}</div><div class=\"flex-1 font-semibold\">${message}</div></div>`;
    toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'),3200);
  }
  function formatTimestampBR(d=new Date()){
    const p=n=> String(n).padStart(2,'0');
    return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
  }
  function showScreen(id){
    ['loginScreen','mainMenu','retiradaScreen','devolucaoScreen','inventarioScreen'].forEach(s=>document.getElementById(s).classList.add('hidden'));
    const el=document.getElementById(id); el.classList.remove('hidden'); el.classList.add('fade-in');
    if(id==='retiradaScreen')   loadObjetosDisponiveis();
    if(id==='devolucaoScreen')  montarDevolucao();
    if(id==='inventarioScreen') prepararInventario();
  }
  function voltarMenu(){ currentFuncionario=null; objetoSelecionadoDevolucao=null; showScreen('mainMenu'); }
  function logout(){ currentSetor=''; currentFuncionario=null; objetoSelecionadoDevolucao=null; document.getElementById('senha').value=''; document.getElementById('setor').value=''; showScreen('loginScreen'); }

  /* ======= JSON (planilha.json) ======= */
  async function carregarPlanilha(){
    try{
      const res = await fetch('planilha.json', { cache:'no-store' });
      if(!res.ok) throw new Error('planilha.json n√£o encontrado');
      const j = await res.json();
      PLANILHA.setores      = Array.isArray(j.setores)? j.setores : [];
      PLANILHA.setoresSenha = (j.setoresSenha && typeof j.setoresSenha==='object') ? j.setoresSenha : {};
      PLANILHA.objetos      = (j.objetos && typeof j.objetos==='object') ? j.objetos : {};
      PLANILHA.funcionarios = Array.isArray(j.funcionarios)? j.funcionarios : [];
      document.getElementById('connectionStatus').innerHTML='<span class=\"badge badge-green\">üìÑ planilha.json carregado e conectado</span>';
      loadSetores();
    }catch(e){
      document.getElementById('connectionStatus').innerHTML='<span class=\"badge badge-red\">‚ùå planilha.json n√£o encontrado</span>';
      console.error(e);
    }
  }
  function loadSetores(){
    const sel=document.getElementById('setor'); sel.innerHTML='<option value=\"\">Selecione um setor...</option>';
    const lista = (PLANILHA.setores && PLANILHA.setores.length ? PLANILHA.setores : Object.keys(PLANILHA.objetos||{}));
    lista.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  }
  document.getElementById('loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const setor=document.getElementById('setor').value.trim();
    const senha=document.getElementById('senha').value;
    if(!setor){ showToast('Selecione o setor','error'); return; }
    const senhaEsperada = PLANILHA.setoresSenha?.[setor] || '';
    if(String(senhaEsperada)!==String(senha)){ showToast('Senha do setor incorreta','error'); return; }
    currentSetor=setor; document.getElementById('setorAtual').textContent='Setor: '+currentSetor;
    showScreen('mainMenu'); showToast('Login realizado com sucesso!');
    await carregarStatusSetorAtual();
  });

  /* ======= FUNCION√ÅRIO ======= */
  function identificarPorMatricula(ctx){
    const inputId=(ctx==='retirada')?'matriculaRetirada':'matriculaInventario';
    const m=(document.getElementById(inputId).value||'').trim();
    if(!m){ showToast('Digite a matr√≠cula','error'); return; }
    const f=(PLANILHA.funcionarios||[]).find(x=> String(x.matricula)===m);
    if(!f){ showToast('Matr√≠cula n√£o encontrada no planilha.json','error'); return; }
    currentFuncionario={ id:f.matricula, nome:f.nome };
    const infoHtml = `<div><b>Matr√≠cula:</b> ${f.matricula}</div><div class='mt-1'><b>Nome:</b> ${f.nome}</div>`;
    const tsHtml   = `<div><b>Identificado em:</b> ${formatTimestampBR()}</div>`;
    if(ctx==='retirada'){
      const a=document.getElementById('funcionarioInfoRetirada'), b=document.getElementById('leituraInfoRetirada');
      a.classList.remove('hidden'); b.classList.remove('hidden'); a.innerHTML=infoHtml; b.innerHTML=tsHtml;
      document.getElementById('objetoSelectionRetirada').classList.remove('hidden');
    }
    if(ctx==='inventario'){
      const a=document.getElementById('funcionarioInfoInventario'), b=document.getElementById('leituraInfoInventario');
      a.classList.remove('hidden'); b.classList.remove('hidden'); a.innerHTML=infoHtml; b.innerHTML=tsHtml;
    }
  }

  /* ======= OBJETOS ======= */
  function objetosDoSetorAtual(){ return PLANILHA.objetos?.[currentSetor] || []; }
  function loadObjetosDisponiveis(){
    const sel=document.getElementById('objetoRetirada'); sel.innerHTML='<option value=\"\">Selecione um objeto...</option>';
    objetosDoSetorAtual().forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
  }

  /* ======= DEVOLU√á√ÉO ======= */
  function montarDevolucao(){
    const wrap=document.getElementById('listaDevolucao');
    const btn=document.getElementById('btnConfirmaDevolucao');
    const msg=document.getElementById('msgSemEmUso');
    wrap.innerHTML=''; btn.disabled=true; msg.classList.add('hidden');

    const objsSetor=new Set(objetosDoSetorAtual());
    const emUso=Object.entries(statusPorObjeto).filter(([obj,info])=> objsSetor.has(obj) && info?.status==='Em Uso');
    if(emUso.length===0){ msg.classList.remove('hidden'); return; }

    wrap.addEventListener('change',ev=>{ if(ev.target && ev.target.name==='dev_obj'){ objetoSelecionadoDevolucao=ev.target.value; btn.disabled=!objetoSelecionadoDevolucao; } }, { once:true });

    emUso.forEach(([obj,info],idx)=>{
      const id='dev_'+idx;
      const row=document.createElement('label'); row.className='flex items-start gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer';
      row.innerHTML = `
        <input type=\"radio\" name=\"dev_obj\" id=\"${id}\" value=\"${obj}\" class=\"mt-1.5\"/>
        <div class=\"flex-1\">
          <div class=\"font-semibold text-gray-800\">${obj}</div>
          <div class=\"text-xs text-gray-600\">em uso por <b>${info.nome||info.matricula||'?'} </b> em ${formatTimestampBR(new Date(info.data||Date.now()))}</div>
        </div>`;
      wrap.appendChild(row);
    });
  }

  /* ======= INVENT√ÅRIO ======= */
  function prepararInventario(){
    const container=document.getElementById('listaObjetosInventario');
    const statusDiv=document.getElementById('statusObjetosInventario');
    const actionsDiv=document.getElementById('inventarioActions');
    const avisoDiv=document.getElementById('inventarioAviso');

    container.innerHTML='';
    const lista=objetosDoSetorAtual();
    if(lista.length===0){
      container.innerHTML='<p class=\"text-gray-500 text-center py-4\">Nenhum objeto encontrado para este setor.</p>';
      statusDiv.classList.remove('hidden'); actionsDiv.classList.add('hidden'); return;
    }

    let algumEmUso=false;
    lista.forEach(nome=>{
      const info=statusPorObjeto[nome];
      const emUso=info && info.status==='Em Uso'; if(emUso) algumEmUso=true;
      const badge = emUso? '<span class=\"badge badge-yellow\">Em Uso</span>' : '<span class=\"badge badge-green\">Devolvido</span>';
      const extra = emUso? `<div class='text-xs text-gray-600'>por <b>${info.nome||info.matricula||'?'} </b> em ${formatTimestampBR(new Date(info.data||Date.now()))}</div>` : '';
      const row=document.createElement('div'); row.className='flex items-start justify-between p-3 border border-gray-200 rounded-lg';
      row.innerHTML = `<div class=\"font-semibold text-gray-800\">${nome}</div><div class=\"text-right\">${badge}${extra? `<div>${extra}</div>`:''}</div>`;
      container.appendChild(row);
    });

    statusDiv.classList.remove('hidden'); actionsDiv.classList.remove('hidden');
    const btn=document.getElementById('btnFinalizarInventario');
    if(algumEmUso){ btn.disabled=true; avisoDiv.innerHTML='<div class=\"text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-2\">H√° objeto(s) <b>Em Uso</b>. Finaliza√ß√£o bloqueada.</div>'; }
    else { btn.disabled=false; avisoDiv.innerHTML='<div class=\"text-sm text-green-700 bg-green-50 border border-green-200 rounded-lg p-2\">Todos os objetos est√£o <b>Devolvidos</b>. Voc√™ pode finalizar.</div>'; }
  }

  /* ======= ENVIO AO FORMS (SEM SETOR) ======= */
  function postToForms({ objeto, matricula, funcionario, acao, detalhe, timestampBR }){
    const form=document.createElement('form'); form.action=GOOGLE_FORM_URL; form.method='POST'; form.target='hidden_iframe';
    const add=(name,val)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=name; i.value=val||''; form.appendChild(i); };
    add(FORMS_FIELDS.objeto,      objeto||'');
    add(FORMS_FIELDS.matricula,   matricula||'');
    add(FORMS_FIELDS.funcionario, funcionario||'');
    add(FORMS_FIELDS.timestamp,   timestampBR||formatTimestampBR());
    if(acao)    add(FORMS_FIELDS.tipoAcao, acao);
    if(detalhe) add(FORMS_FIELDS.detalhe,  detalhe);
    add('fvv','1'); add('pageHistory','0'); add('fbzx', String(Math.random()).slice(2));
    document.body.appendChild(form); form.submit(); document.body.removeChild(form);
  }

  /* ======= A√á√ïES ======= */
  function confirmarRetirada(){
    const objeto=(document.getElementById('objetoRetirada').value||'').trim();
    if(!objeto){ showToast('Selecione um objeto do dropdown','error'); return; }
    if(!currentFuncionario){ showToast('Identifique o funcion√°rio','error'); return; }
    const nome=currentFuncionario.nome; const mat=currentFuncionario.id; const ts=formatTimestampBR();
    showConfirm(`Confirma a retirada de \"${objeto}\"?`, ()=>{
      postToForms({ objeto, matricula:mat, funcionario:nome, acao:'Retirada', detalhe:'Em Uso', timestampBR:ts });
      statusPorObjeto[objeto]={ status:'Em Uso', nome, matricula:mat, data:new Date() };
      showToast('Retirada registrada!'); voltarMenu();
    });
  }
  function confirmarDevolucao(){
    if(!objetoSelecionadoDevolucao){ showToast('Selecione um objeto em uso','error'); return; }
    const objeto=objetoSelecionadoDevolucao; const info=statusPorObjeto[objeto]||{}; const ts=formatTimestampBR();
    showConfirm(`Confirmar devolu√ß√£o de \"${objeto}\"?`, ()=>{
      postToForms({ objeto, matricula:info.matricula||'', funcionario:info.nome||'', acao:'Devolu√ß√£o', detalhe:'Devolvido', timestampBR:ts });
      statusPorObjeto[objeto]={ status:'Devolvido', nome:'', matricula:'', data:new Date() };
      showToast('Devolu√ß√£o registrada!'); montarDevolucao();
    });
  }
  function finalizarInventario(){
    if(!currentFuncionario){ showToast('Identifique o funcion√°rio','error'); return; }
    const lista=objetosDoSetorAtual(); const algumEmUso=lista.some(o=> statusPorObjeto[o]?.status==='Em Uso');
    if(algumEmUso){ showToast('H√° objeto(s) Em Uso. Bloqueado.','error'); return; }
    const nome=currentFuncionario.nome; const mat=currentFuncionario.id; const ts=formatTimestampBR();
    showConfirm('Finalizar invent√°rio (todos como Devolvido)?', ()=>{
      lista.forEach(objeto=>{
        postToForms({ objeto, matricula:mat, funcionario:nome, acao:'Invent√°rio de Final de Turno', detalhe:'Devolvido', timestampBR:ts });
        statusPorObjeto[objeto]={ status:'Devolvido', nome:'', matricula:'', data:new Date() };
      });
      showToast('Invent√°rio finalizado!'); voltarMenu();
    });
  }

  /* ======= MODAL ======= */
  let confirmCallback=null; function showConfirm(msg, cb){ const m=document.getElementById('confirmModal'); document.getElementById('confirmMessage').textContent=msg; m.classList.remove('hidden'); confirmCallback=cb; document.getElementById('confirmButton').onclick=()=>{ m.classList.add('hidden'); if(confirmCallback){ confirmCallback(); confirmCallback=null; } }; }
  function cancelConfirm(){ document.getElementById('confirmModal').classList.add('hidden'); confirmCallback=null; }

  /* ======= CSV/Mapeamento p/ leitura ======= */
  function csvToRows(text){ const rows=[]; let i=0, cur=[], field='', inQ=false; while(i<text.length){ const c=text[i]; if(c==='"'){ if(inQ && text[i+1]==='"'){ field+='"'; i++; } else { inQ=!inQ; } } else if(c===',' && !inQ){ cur.push(field); field=''; } else if((c==='\n'||c==='\r')&&!inQ){ if(field!==''||cur.length>0){ cur.push(field); rows.push(cur); cur=[]; field=''; } } else { field+=c; } i++; } if(field!==''||cur.length>0){ cur.push(field); rows.push(cur); } return rows.filter(r=> r.length>1 || (r.length===1 && r[0].trim()!=='') ); }
  function normalize(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  function mapCols(headers){ const idx={}; headers.forEach((h,i)=>{ const n=normalize(h); if(n.includes('objeto')) idx.objeto=i; else if(n.includes('matric')) idx.matricula=i; else if(n.includes('funcion')) idx.funcionario=i; else if(n.includes('carimbo')) idx.carimbo=i; else if(n.includes('timestamp')||n.includes('data')&&n.includes('hora')) idx.timestamp=i; else if(n.includes('tipo de a√ß√£o')||n.includes('tipo de acao')) idx.tipoAcao=i; else if(n.includes('detalhe')) idx.detalhe=i; }); return idx; }

  async function carregarStatusSetorAtual(){
    statusPorObjeto = {}; const registros=[]; const objsSet = new Set(objetosDoSetorAtual());
    for(const tab of SHEET_TABS){ const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`; try{ const res=await fetch(url); if(!res.ok) continue; const text=await res.text(); const rows=csvToRows(text); if(!rows.length) continue; const headers=rows[0]; const idx=mapCols(headers); rows.slice(1).forEach(r=>{ const objeto=idx.objeto!=null?(r[idx.objeto]||''):''; if(!objeto||!objsSet.has(objeto)) return; let data=null; const raw = idx.timestamp!=null?(r[idx.timestamp]||''): (idx.carimbo!=null?(r[idx.carimbo]||''): ''); const m=String(raw).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})[ T](\d{2}):(\d{2}):(\d{2})$/); if(m){ const[_,dd,mm,yyyy,HH,MM,SS]=m; data=new Date(`${yyyy}-${mm}-${dd}T${HH}:${MM}:${SS}`);} else { const d1=new Date(raw); if(!isNaN(d1)) data=d1; }
      let status=''; if(idx.tipoAcao!=null){ const acao=(r[idx.tipoAcao]||'').trim(); if(acao==='Retirada') status='Em Uso'; else if(acao==='Devolu√ß√£o') status='Devolvido'; else if(acao==='Invent√°rio de Final de Turno') status='Devolvido'; }
      registros.push({ objeto, status, nome: idx.funcionario!=null?(r[idx.funcionario]||''):'', matricula: idx.matricula!=null?(r[idx.matricula]||''):'', data }); }); }catch(e){ console.warn('Falha ao ler',tab,e); } }
    const map=new Map(); for(const r of registros){ const cur = map.get(r.objeto); if(!cur || (r.data && (!cur.data || r.data>cur.data))) map.set(r.objeto,r); }
    map.forEach(v=>{ statusPorObjeto[v.objeto]={ status:v.status, nome:v.nome, matricula:v.matricula, data:v.data }; });
  }

  /* ======= Diagn√≥stico ======= */
  function enviarDiagnostico(){ try{ const setor=currentSetor || (PLANILHA.setores && PLANILHA.setores[0]) || Object.keys(PLANILHA.objetos||{})[0] || 'Teste'; const objeto=(PLANILHA.objetos?.[setor]||[])[0] || 'DIAGNOSTICO_TESTE'; const matricula=(PLANILHA.funcionarios?.[0]?.matricula)||'00000'; const funcionario=(PLANILHA.funcionarios?.[0]?.nome)||'DIAGNOSTICO'; const ts=formatTimestampBR(); const form=document.createElement('form'); form.action=GOOGLE_FORM_URL; form.method='POST'; form.target='hidden_iframe'; const add=(n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v||''; form.appendChild(i); }; add(FORMS_FIELDS.objeto,objeto); add(FORMS_FIELDS.matricula,matricula); add(FORMS_FIELDS.funcionario,funcionario); add(FORMS_FIELDS.timestamp,ts); add(FORMS_FIELDS.tipoAcao,'Retirada'); add(FORMS_FIELDS.detalhe,'Em Uso'); add('fvv','1'); add('pageHistory','0'); add('fbzx', String(Math.random()).slice(2)); document.body.appendChild(form); form.submit(); document.body.removeChild(form); showToast('üß™ Amostra enviada. Aguarde ~10s e verifique o Forms/Sheets.'); }catch(e){ showToast('Falha no diagn√≥stico: '+e.message,'error'); console.error(e); } }

  async function lerStatusDiagnostico(){ if(!currentSetor){ showToast('Fa√ßa login (defina o setor)','error'); return; } let total=0; let itens=[]; const objsSet=new Set(objetosDoSetorAtual()); for(const tab of SHEET_TABS){ try{ const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`; const res=await fetch(url); if(!res.ok) continue; const text=await res.text(); const rows=csvToRows(text); if(!rows.length) continue; const headers=rows[0]; const idx=mapCols(headers); rows.slice(1).forEach(r=>{ const objeto=idx.objeto!=null?(r[idx.objeto]||''):''; if(!objeto||!objsSet.has(objeto)) return; let data=null; const raw = idx.timestamp!=null?(r[idx.timestamp]||''): (idx.carimbo!=null?(r[idx.carimbo]||''): ''); const m=String(raw).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})[ T](\d{2}):(\d{2}):(\d{2})$/); if(m){ const[_,dd,mm,yyyy,HH,MM,SS]=m; data=new Date(`${yyyy}-${mm}-${dd}T${HH}:${MM}:${SS}`);} else { const d1=new Date(raw); if(!isNaN(d1)) data=d1; } let status=''; if(idx.tipoAcao!=null){ const acao=(r[idx.tipoAcao]||'').trim(); if(acao==='Retirada') status='Em Uso'; else if(acao==='Devolu√ß√£o') status='Devolvido'; else if(acao==='Invent√°rio de Final de Turno') status='Devolvido'; } itens.push({objeto,status,data}); total++; }); }catch(e){ console.warn('diag read fail',e); } } const map=new Map(); for(const it of itens){ const cur=map.get(it.objeto); if(!cur || (it.data && (!cur.data || it.data>cur.data))) porObjeto.set(r.objeto, r); } let emUso=0, dev=0; map.forEach(v=>{ if(v.status==='Em Uso') emUso++; else if(v.status==='Devolvido') dev++; }); showToast('Diagn√≥stico de leitura conclu√≠do!'); alert(`üîÑ Diagn√≥stico:\n‚Ä¢ Abas lidas: ${SHEET_TABS.join(', ')}\n‚Ä¢ Setor: ${currentSetor}\n‚Ä¢ Registros lidos (bruto): ${total}\n‚Ä¢ Objetos consolidados: ${map.size}\n   - Em Uso: ${emUso}\n   - Devolvido: ${dev}`); }

  /* ======= Boot ======= */
  window.addEventListener('DOMContentLoaded', ()=>{ carregarPlanilha(); });
  </script>
</body>
</html>
