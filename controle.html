<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KnifeControl – Controle & Relatórios (Join CSV)</title>
  <!-- ====== Bibliotecas para exportação ====== -->
  <!-- XLSX (SheetJS) para gerar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF + AutoTable para gerar PDF com tabela -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{color-scheme:light dark;--bg:#f7f8fa; --fg:#0f172a; --card:#fff; --muted:#64748b; --line:#e5e7eb; --pri:#2563eb; --pri-2:#1d4ed8; --ok:#16a34a; --warn:#f59e0b; --err:#dc2626; --chip:#eef2ff; --chip-fg:#1e3a8a}
    @media (prefers-color-scheme: dark){:root{--bg:#0b0d10; --fg:#e5e7eb; --card:#111418; --muted:#94a3b8; --line:#1f2937; --pri:#60a5fa; --pri-2:#3b82f6; --ok:#34d399; --warn:#fbbf24; --err:#f87171; --chip:#0b1220; --chip-fg:#93c5fd}}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(0,0,0,.06), transparent), var(--card);border-bottom:1px solid var(--line);backdrop-filter:blur(8px)}
    .topbar{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
    .logo{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,#111827,#1f2937);display:grid;place-items:center;color:#fff;font-weight:800}
    .title{font-weight:800;font-size:16px}
    .tabs{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;cursor:pointer;border:1px solid var(--line);background:transparent;color:var(--fg)}
    .tab.active{background:var(--pri);color:#fff;border-color:transparent}
    main{max-width:1200px;margin:18px auto;padding:0 16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text], input[type=date], select, textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--fg)}
    button{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn{background:var(--pri);color:#fff}.btn:hover{background:var(--pri-2)}
    .btn-ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
    .btn-ok{background:var(--ok);color:#073b2a}.btn-warn{background:var(--warn)}.btn-err{background:var(--err);color:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    tr:hover td{background:rgba(148,163,184,.1)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:var(--chip);color:var(--chip-fg);padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    .muted{color:var(--muted)}
    .pill{background:#00000010;border:1px solid var(--line);padding:8px 10px;border-radius:999px}
    .danger{color:var(--err);font-weight:700}
    .success{color:var(--ok);font-weight:700}
    dialog{border:none;border-radius:14px;background:var(--card);color:var(--fg);padding:0;max-width:520px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.35);border:1px solid var(--line)}
    .modal-head{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:800}
    .modal-body{padding:16px}
    .modal-foot{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#00000008}
    .danger-zone{border:1px dashed var(--err);padding:12px;border-radius:12px}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="logo">KC</div>
    <div class="title">KnifeControl – Relatórios & Cadastros</div>
    <div class="tabs">
      <button class="tab active" data-tab="relatorios">Relatórios</button>
      <button class="tab" data-tab="mov">Movimentações</button>
      <button class="tab" data-tab="cadastros">Cadastros</button>
      <button class="tab" data-tab="config">Config/Salvar</button>
    </div>
  </div>
</header>
<main>
  <!-- ===================== RELATÓRIOS ===================== -->
  <section class="card" data-panel="relatorios">
    <h2 style="margin-top:0">Relatórios</h2>
    <div class="row">
      <div class="col"><label>Matrícula</label><input type="text" id="fMatricula" placeholder="Digite a matrícula"/></div>
      <div class="col"><label>Funcionário</label><input type="text" id="fFuncionario" placeholder="Digite o nome"/></div>
      <div class="col"><label>Setor</label><select id="fSetor"><option value="">Todos</option></select></div>
      <div class="col"><label>Objeto</label><select id="fObjeto"><option value="">Todos</option></select></div>
      <div class="col"><label>Data Retirada</label><input type="date" id="fDataRet"/></div>
      <div class="col"><label>Data Devolução</label><input type="date" id="fDataDev"/></div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button class="btn" id="btnBuscar">Buscar</button>
      <button class="btn-ghost" id="btnLimpar">Limpar</button>
      <div class="spacer"></div>
      <button class="btn" id="btnXLS">Gerar XLS</button>
      <button class="btn" id="btnPDF">Gerar PDF</button>
    </div>
    <div class="chips" id="chipsInfo"></div>
    <div style="margin-top:10px;overflow:auto">
      <table id="tblResultado">
        <thead>
          <tr><th>Matrícula</th><th>Funcionário</th><th>Setor</th><th>Objeto</th><th>Data Retirada</th><th>Data Devolução</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="muted">Faça uma busca para exibir os resultados…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ===================== MOVIMENTAÇÕES ===================== -->
  <section class="card" data-panel="mov" hidden>
    <h2 style="margin-top:0">Movimentações</h2>
    <div class="row">
      <div class="col"><label>Funcionário</label><select id="mvFuncionario"></select></div>
      <div class="col"><label>Setor</label><select id="mvSetor"></select></div>
      <div class="col"><label>Objeto</label><select id="mvObjeto"></select></div>
      <div class="col"><label>Dispositivo</label><input type="text" id="mvDevice" placeholder="Ex: Chrome Android"/></div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button class="btn" id="btnRetirada">Registrar Retirada</button>
      <button class="btn-ghost" id="btnDevolucao">Registrar Devolução</button>
      <div class="spacer"></div>
      <button class="btn-ghost" id="btnListarAbertos">Listar retiradas em aberto</button>
    </div>
    <div id="abertos" class="chips"></div>
  </section>

  <!-- ===================== CADASTROS ===================== -->
  <section class="card" data-panel="cadastros" hidden>
    <h2 style="margin-top:0">Cadastros</h2>
    <div class="row">
      <div class="col">
        <div class="pill"><b>Funcionários</b></div>
        <div class="toolbar" style="margin:8px 0"><button class="btn" id="addFunc">Incluir Funcionário</button></div>
        <div style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px">
          <table id="tblFunc"><thead><tr><th>Matrícula</th><th>Nome</th><th>Setor</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="col">
        <div class="pill"><b>Setores</b></div>
        <div class="toolbar" style="margin:8px 0"><button class="btn" id="addSetor">Incluir Setor</button></div>
        <div style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px">
          <table id="tblSetores"><thead><tr><th>Setor</th><th>Senha</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="col">
        <div class="pill"><b>Objetos</b></div>
        <div class="toolbar" style="margin:8px 0"><button class="btn" id="addObjeto">Incluir Objeto</button></div>
        <div style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px">
          <table id="tblObjetos"><thead><tr><th>Setor</th><th>Objeto</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
    <div class="danger-zone" style="margin-top:16px">
      <div class="danger">Zona de risco</div>
      <p class="muted" style="margin:6px 0 0">Excluir itens remove imediatamente do JSON em memória. Clique em “Salvar alterações” na aba Config para persistir.</p>
    </div>
  </section>

  <!-- ===================== CONFIG / SALVAR ===================== -->
  <section class="card" data-panel="config" hidden>
    <h2 style="margin-top:0">Configuração & Salvamento</h2>
    <p class="muted">Após editar cadastros e registrar movimentações, salve seu <b>planilha.json</b> atualizado:</p>
    <div class="toolbar" style="margin:12px 0">
      <button class="btn" id="btnSalvar">Salvar alterações (abrir backend)</button>
      <button class="btn-ghost" id="btnBaixarLocal">Baixar cópia local (fallback)</button>
    </div>
    <pre id="jsonPreview" style="max-height:320px;overflow:auto;background:#00000010;border:1px solid var(--line);border-radius:10px;padding:12px"></pre>

    <!-- Bloco de integração com Google Sheets (CSV) -->
    <div class="card" style="margin-top:8px">
      <h3 style="margin:0 0 8px">Logs do Google Sheets (CSV)</h3>
      <div class="row">
        <div class="col">
          <label>URL pública do CSV (aba Logs do Google Sheets)</label>
          <input type="text" id="urlCSVLogs" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vR0W_EANuBmwkGui9FSDslCOzAb5vrGhd1daq0MRvMyatzaC-Y5PGf8w2dHCeuNAmlNvWhh1uBWdp9T/pub?gid=354771550&single=true&output=csv" placeholder="Cole aqui a URL publicada (output=csv)"/>
        </div>
        <div class="col" style="max-width:260px">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="chkConsolidar" checked/> Consolidar RETIRADA/DEVOLUÇÃO
          </label>
        </div>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn-ghost" id="btnPreviewCSV">Pré-visualizar (amostra)</button>
        <button class="btn" id="btnUsarCSV">Usar Logs do Sheets nesta sessão</button>
      </div>
      <pre id="csvPreview" class="muted" style="max-height:180px; overflow:auto; background:#00000008; border:1px solid var(--line); border-radius:10px; padding:10px"></pre>
    </div>
  </section>
</main>

<!-- ===================== Modal Genérico (para CRUD) ===================== -->
<dialog id="dlg">
  <div class="modal-head" id="dlgTitle">Título</div>
  <div class="modal-body" id="dlgBody"></div>
  <div class="modal-foot">
    <button class="btn-ghost" id="dlgCancel">Cancelar</button>
    <button class="btn" id="dlgOk">Salvar</button>
  </div>
</dialog>

<script>
// =================== PARTE 2/5 – Utilitários, carregamento ===================
let DB = null;          // estado do planilha.json
let sujo = false;       // flag de alterações não persistidas
let cacheRelatorio = []; // linhas consolidadas (XLS/PDF)

const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Sao_Paulo';
const fmtDateTime = (d)=> new Date(d).toLocaleString('pt-BR',{timeZone:tz});
const fmtDate = (d)=> new Date(d).toISOString().slice(0,10);
const normalize = (s)=> (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
const qs = (sel)=> document.querySelector(sel);
const qsa = (sel)=> Array.from(document.querySelectorAll(sel));

// Logo base64 (opcional)
const LOGO_LSG_BASE64 = "";

function markDirty(flag=true){
  sujo = flag;
  qs('.title').textContent = 'KnifeControl – ' + (sujo ? '\uD83D\uDD34 Alterações não salvas' : 'Relatórios & Cadastros');
  renderJSONPreview();
}
function renderJSONPreview(){ if(!DB) return; qs('#jsonPreview').textContent = JSON.stringify(DB,null,2); }

qsa('.tab').forEach(b=>{
  b.addEventListener('click', ()=>{
    qsa('.tab').forEach(t=>t.classList.remove('active'));
    b.classList.add('active');
    const tab = b.dataset.tab;
    qsa('[data-panel]').forEach(p=> p.hidden = (p.dataset.panel !== tab));
  });
});

async function carregar(){
  const res = await fetch('planilha.json?cache='+Date.now());
  DB = await res.json();
  if(!Array.isArray(DB.setores)) DB.setores = [];
  if(typeof DB.setoresSenha !== 'object') DB.setoresSenha = {};
  if(typeof DB.objetos !== 'object') DB.objetos = {};
  if(!Array.isArray(DB.funcionarios)) DB.funcionarios = [];
  if(!Array.isArray(DB.logs)) DB.logs = [];
  popularFiltros();
  preencherCadastros();
  popularMov();
  renderJSONPreview();
}
carregar().catch(err=>{ alert('Erro ao carregar planilha.json: '+ err); });

function popularFiltros(){
  const fSetor = qs('#fSetor');
  const fObjeto = qs('#fObjeto');
  fSetor.innerHTML = '<option value="">Todos</option>' + (DB.setores||[]).map(s=>`<option>${s}</option>`).join('');
  const allObjs = Object.values(DB.objetos||{}).flat().filter(Boolean);
  const uniq = Array.from(new Set(allObjs));
  fObjeto.innerHTML = '<option value="">Todos</option>' + uniq.map(o=>`<option>${o}</option>`).join('');
}

function popularMov(){
  const mvFuncionario = qs('#mvFuncionario');
  const mvSetor = qs('#mvSetor');
  const mvObjeto = qs('#mvObjeto');
  mvFuncionario.innerHTML = (DB.funcionarios || [])
    .map(f => `<option value="${f.matricula}">${f.matricula} – ${f.nome} (${f.setor || '-'})</option>`)
    .join('');
  mvSetor.innerHTML = (DB.setores || []).map(s=>`<option>${s}</option>`).join('');
  mvSetor.onchange = ()=>{
    const setor = mvSetor.value;
    const objs = (DB.objetos?.[setor]) || [];
    mvObjeto.innerHTML = objs.map(o=>`<option>${o}</option>`).join('');
  };
  mvSetor.dispatchEvent(new Event('change'));
  qs('#mvDevice').value = detectarDevice();
}

function detectarDevice(){
  const ua = navigator.userAgent || '';
  if(/Android/i.test(ua)) return 'Chrome Android';
  if(/iPhone|iPad/i.test(ua)) return 'Safari iOS';
  if(/Windows/i.test(ua)) return 'Chrome/Edge Windows';
  if(/Macintosh/i.test(ua)) return 'Safari macOS';
  return 'Navegador';
}
</script>

<script>
// =================== PARTE 3/5 – CRUD + modais ===================
function preencherCadastros(){
  // Funcionários
  const tf = qs('#tblFunc tbody'); tf.innerHTML = '';
  (DB.funcionarios || []).forEach((f,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(f.matricula || '')}</td>
      <td>${escapeHTML(f.nome || '')}</td>
      <td>${escapeHTML(f.setor || '')}</td>
      <td style="text-align:right">
        <button class="btn-ghost" data-edit-func="${idx}">Editar</button>
        <button class="btn-err" data-del-func="${idx}">Excluir</button>
      </td>`;
    tf.appendChild(tr);
  });

  // Setores
  const ts = qs('#tblSetores tbody'); ts.innerHTML = '';
  (DB.setores || []).forEach((s,idx)=>{
    const senha = DB.setoresSenha?.[s] || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(s)}</td>
      <td>${escapeHTML(senha)}</td>
      <td style="text-align:right">
        <button class="btn-ghost" data-edit-setor="${idx}">Editar</button>
        <button class="btn-err" data-del-setor="${idx}">Excluir</button>
      </td>`;
    ts.appendChild(tr);
  });

  // Objetos
  const to = qs('#tblObjetos tbody'); to.innerHTML = '';
  (DB.setores || []).forEach(s=>{
    const objs = DB.objetos?.[s] || [];
    objs.forEach((o,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHTML(s)}</td>
        <td>${escapeHTML(o)}</td>
        <td style="text-align:right">
          <button class="btn-ghost" data-edit-obj="${encodeURIComponent(s)}|${i}">Editar</button>
          <button class="btn-err" data-del-obj="${encodeURIComponent(s)}|${i}">Excluir</button>
        </td>`;
      to.appendChild(tr);
    });
  });
}

function escapeHTML(s){
  return (s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

// Incluir Funcionário
qs('#addFunc')?.addEventListener('click', ()=>{
  openModal('Incluir Funcionário', `
    <div class="row">
      <div class="col"><label>Matrícula</label><input id="mMat" type="text" placeholder="Ex: 10001"/></div>
      <div class="col"><label>Nome</label><input id="mNome" type="text" placeholder="Ex: João Silva"/></div>
      <div class="col"><label>Setor</label>
        <select id="mSetor">${(DB.setores||[]).map(s=>`<option>${escapeHTML(s)}</option>`).join('')}</select>
      </div>
    </div>`, ()=>{
      const f = { matricula: qs('#mMat').value.trim(), nome: qs('#mNome').value.trim(), setor: qs('#mSetor').value };
      if(!f.matricula || !f.nome){ alert('Informe matrícula e nome.'); return false; }
      DB.funcionarios.push(f);
      markDirty(); preencherCadastros(); popularMov(); popularFiltros();
      return true;
    });
});

// Incluir Setor
qs('#addSetor')?.addEventListener('click', ()=>{
  openModal('Incluir Setor', `
    <div class="row">
      <div class="col"><label>Nome do Setor</label><input id="mSet" type="text" placeholder="Ex: Padaria"/></div>
      <div class="col"><label>Senha do Setor</label><input id="mSenha" type="text" placeholder="Ex: padaria"/></div>
    </div>`, ()=>{
      const s = qs('#mSet').value.trim();
      const senha = qs('#mSenha').value.trim();
      if(!s){ alert('Informe o nome do setor.'); return false; }
      if(DB.setores.includes(s)){ alert('Este setor já existe.'); return false; }
      DB.setores.push(s);
      DB.objetos[s] = DB.objetos[s] || [];
      DB.setoresSenha = DB.setoresSenha || {};
      DB.setoresSenha[s] = senha || '';
      markDirty(); preencherCadastros(); popularMov(); popularFiltros();
      return true;
    });
});

// Incluir Objeto
qs('#addObjeto')?.addEventListener('click', ()=>{
  openModal('Incluir Objeto', `
    <div class="row">
      <div class="col"><label>Setor</label><select id="mSet">${(DB.setores||[]).map(s=>`<option>${escapeHTML(s)}</option>`).join('')}</select></div>
      <div class="col"><label>Objeto</label><input id="mObj" type="text" placeholder="Ex: 89 – FACA"/></div>
    </div>`, ()=>{
      const s = qs('#mSet').value;
      const o = qs('#mObj').value.trim();
      if(!o){ alert('Informe o nome do objeto.'); return false; }
      DB.objetos[s] = DB.objetos[s] || [];
      if(DB.objetos[s].includes(o)){ alert('Este objeto já existe neste setor.'); return false; }
      DB.objetos[s].push(o);
      markDirty(); preencherCadastros(); popularMov(); popularFiltros();
      return true;
    });
});

// Ações Funcionários
qs('#tblFunc')?.addEventListener('click', e=>{
  const b = e.target.closest('button'); if(!b) return;
  if(b.dataset.editFunc){
    const i = +b.dataset.editFunc; const f = DB.funcionarios[i];
    openModal('Editar Funcionário', `
      <div class="row">
        <div class="col"><label>Matrícula</label><input id="mMat" type="text" value="${escapeHTML(f.matricula||'')}"/></div>
        <div class="col"><label>Nome</label><input id="mNome" type="text" value="${escapeHTML(f.nome||'')}"/></div>
        <div class="col"><label>Setor</label>
          <select id="mSetor">${(DB.setores||[]).map(s=>`<option ${s===f.setor?'selected':''}>${escapeHTML(s)}</option>`).join('')}</select>
        </div>
      </div>`, ()=>{
        const novo = { matricula: qs('#mMat').value.trim(), nome: qs('#mNome').value.trim(), setor: qs('#mSetor').value };
        if(!novo.matricula || !novo.nome){ alert('Informe matrícula e nome.'); return false; }
        DB.funcionarios[i] = novo; markDirty(); preencherCadastros(); popularMov(); popularFiltros(); return true;
      });
  }
  if(b.dataset.delFunc){
    const i = +b.dataset.delFunc; if(confirm('Excluir este funcionário?')){ DB.funcionarios.splice(i,1); markDirty(); preencherCadastros(); popularMov(); popularFiltros(); }
  }
});

// Ações Setores
qs('#tblSetores')?.addEventListener('click', e=>{
  const b = e.target.closest('button'); if(!b) return;
  if(b.dataset.editSetor){
    const idx = +b.dataset.editSetor; const nome = DB.setores[idx]; const senhaAtual = DB.setoresSenha?.[nome] || '';
    openModal('Editar Setor', `
      <div class="row">
        <div class="col"><label>Nome do Setor</label><input id="mSet" type="text" value="${escapeHTML(nome)}"/></div>
        <div class="col"><label>Senha do Setor</label><input id="mSenha" type="text" value="${escapeHTML(senhaAtual)}"/></div>
      </div>`, ()=>{
        const novoNome = qs('#mSet').value.trim(); const novaSenha = qs('#mSenha').value.trim();
        if(!novoNome){ alert('Informe o nome do setor.'); return false; }
        if(novoNome !== nome){
          if(DB.setores.includes(novoNome)){ alert('Já existe um setor com esse nome.'); return false; }
          DB.setores[idx] = novoNome;
          DB.objetos[novoNome] = (DB.objetos[nome] || []).slice(); delete DB.objetos[nome];
          DB.setoresSenha[novoNome] = novaSenha; delete DB.setoresSenha[nome];
          (DB.funcionarios||[]).forEach(f=>{ if(f.setor===nome) f.setor = novoNome; });
          (DB.logs||[]).forEach(l=>{ if(l.setor===nome) l.setor = novoNome; });
        } else {
          DB.setoresSenha[nome] = novaSenha;
        }
        markDirty(); preencherCadastros(); popularMov(); popularFiltros(); return true;
      });
  }
  if(b.dataset.delSetor){
    const idx = +b.dataset.delSetor; const nome = DB.setores[idx];
    if(!confirm(`Excluir o setor "${nome}"? Objetos vinculados também serão removidos. Esta ação é irreversível.`)) return;
    DB.setores.splice(idx,1); delete DB.objetos[nome]; if(DB.setoresSenha) delete DB.setoresSenha[nome];
    (DB.funcionarios||[]).forEach(f=>{ if(f.setor===nome) f.setor=''; });
    (DB.logs||[]).forEach(l=>{ if(l.setor===nome) l.setor=''; });
    markDirty(); preencherCadastros(); popularMov(); popularFiltros();
  }
});

// Ações Objetos
qs('#tblObjetos')?.addEventListener('click', e=>{
  const b = e.target.closest('button'); if(!b) return;
  if(b.dataset.editObj){
    const [setorEnc, iStr] = b.dataset.editObj.split('|');
    const setor = decodeURIComponent(setorEnc); const idx = +iStr; const atual = (DB.objetos?.[setor]||[])[idx];
    openModal('Editar Objeto', `
      <div class="row">
        <div class="col"><label>Setor</label>
          <select id="mSet">${(DB.setores||[]).map(s=>`<option ${s===setor?'selected':''}>${escapeHTML(s)}</option>`).join('')}</select>
        </div>
        <div class="col"><label>Objeto</label><input id="mObj" type="text" value="${escapeHTML(atual||'')}"/></div>
      </div>`, ()=>{
        const novoSet = qs('#mSet').value; const novoObj = qs('#mObj').value.trim();
        if(!novoObj){ alert('Informe o nome do objeto.'); return false; }
        DB.objetos[setor].splice(idx,1);
        DB.objetos[novoSet] = DB.objetos[novoSet] || []; DB.objetos[novoSet].push(novoObj);
        (DB.logs||[]).forEach(l=>{ if(l.setor===setor && l.objeto===atual){ l.setor = novoSet; l.objeto = novoObj; }});
        markDirty(); preencherCadastros(); popularMov(); popularFiltros(); return true;
      });
  }
  if(b.dataset.delObj){
    const [setorEnc, iStr] = b.dataset.delObj.split('|');
    const setor = decodeURIComponent(setorEnc); const idx = +iStr; const atual = (DB.objetos?.[setor]||[])[idx];
    if(confirm(`Excluir objeto "${atual}" do setor "${setor}"?`)){
      DB.objetos[setor].splice(idx,1);
      (DB.logs||[]).forEach(l=>{ if(l.setor===setor && l.objeto===atual) l.objeto=''; });
      markDirty(); preencherCadastros(); popularMov(); popularFiltros();
    }
  }
});

function openModal(titulo, html, onOk){
  const dlg = qs('#dlg');
  qs('#dlgTitle').textContent = titulo;
  qs('#dlgBody').innerHTML = html;
  dlg.showModal();
  const destroy = ()=>{ dlg.close(); qs('#dlgOk').onclick=null; qs('#dlgCancel').onclick=null; };
  qs('#dlgCancel').onclick = ()=> destroy();
  qs('#dlgOk').onclick = ()=>{ try{ const ok = onOk && onOk(); if(ok!==false) destroy(); } catch(err){ alert('Erro ao salvar: '+ (err?.message||err)); } };
}
</script>

<script>
// =================== PARTE 4/5 – Relatórios + Exportações ===================
qs('#btnBuscar')?.addEventListener('click', ()=>{
  const matricula = qs('#fMatricula').value.trim();
  const funcionario = qs('#fFuncionario').value.trim();
  const setor = qs('#fSetor').value;
  const objeto = qs('#fObjeto').value;
  const dtRet = qs('#fDataRet').value;
  const dtDev = qs('#fDataDev').value;

  const linhas = consolidarPares(DB.logs || []);
  let out = linhas.slice();
  if(matricula) out = out.filter(r=> (r.matricula||'').includes(matricula));
  if(funcionario){ const nf = normalize(funcionario); out = out.filter(r=> normalize(r.funcionario).includes(nf)); }
  if(setor) out = out.filter(r=> r.setor===setor);
  if(objeto) out = out.filter(r=> r.objeto===objeto);
  if(dtRet) out = out.filter(r=> (r.dataRet||'').startsWith(dtRet));
  if(dtDev) out = out.filter(r=> (r.dataDev||'').startsWith(dtDev));

  cacheRelatorio = out;
  preencherTabela(out);
  renderChips(out.length);
});

qs('#btnLimpar')?.addEventListener('click', ()=>{
  ['#fMatricula','#fFuncionario','#fSetor','#fObjeto','#fDataRet','#fDataDev'].forEach(sel=> qs(sel).value='');
  cacheRelatorio = []; preencherTabela([]); qs('#chipsInfo').innerHTML='';
});

function renderChips(qtd){
  const F = { 'Matrícula':qs('#fMatricula').value, 'Funcionário':qs('#fFuncionario').value, 'Setor':qs('#fSetor').value, 'Objeto':qs('#fObjeto').value, 'Data Retirada':qs('#fDataRet').value, 'Data Devolução':qs('#fDataDev').value };
  const chips = Object.entries(F).filter(([,v])=>v).map(([k,v])=>`<span class=\"chip\">${k}: <b>${escapeHTML(v)}</b></span>`);
  chips.push(`<span class=\"chip\">Resultados: <b>${qtd}</b></span>`);
  qs('#chipsInfo').innerHTML = chips.join('');
}

function preencherTabela(linhas){
  const tb = qs('#tblResultado tbody'); tb.innerHTML = '';
  if(!linhas.length){ tb.innerHTML = '<tr><td colspan="6" class="muted">Nenhum resultado encontrado.</td></tr>'; return; }
  const frag = document.createDocumentFragment();
  linhas.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(r.matricula||'')}</td>
      <td>${escapeHTML(r.funcionario||'')}</td>
      <td>${escapeHTML(r.setor||'')}</td>
      <td>${escapeHTML(r.objeto||'')}</td>
      <td>${escapeHTML(r.dataRet||'')}</td>
      <td>${escapeHTML(r.dataDev||'')}</td>`;
    frag.appendChild(tr);
  });
  tb.appendChild(frag);
}

function consolidarPares(logs){
  const arr = (logs||[]).slice().sort((a,b)=> (a.timestamp||'').localeCompare(b.timestamp||''));
  const key = x => [x.matricula,x.setor,x.objeto].join('||');
  const buckets = new Map();
  for(const l of arr){ if(!l || !l.acao) continue; const k = key(l); if(!buckets.has(k)) buckets.set(k,[]); buckets.get(k).push(l); }
  const result = [];
  for(const [k,events] of buckets){
    const usados = new Set();
    events.forEach((ev,i)=>{
      if(ev.acao!=='RETIRADA') return;
      const devIndex = events.findIndex((d,j)=> j>i && d.acao==='DEVOLUCAO' && !usados.has(j));
      const dataRet = ev.timestamp ? ev.timestamp.slice(0,10) : '';
      const dataDev = (devIndex>=0 && events[devIndex].timestamp) ? events[devIndex].timestamp.slice(0,10) : '';
      if(devIndex>=0) usados.add(devIndex);
      result.push({ matricula:ev.matricula||'', funcionario:ev.funcionario||'', setor:ev.setor||'', objeto:ev.objeto||'', dataRet, dataDev });
    });
  }
  return result;
}

qs('#btnXLS')?.addEventListener('click', ()=>{
  const data = cacheRelatorio.length ? cacheRelatorio : consolidarPares(DB.logs||[]);
  if(!data.length){ alert('Não há dados para exportar.'); return; }
  const rows = data.map(r=>({'Matrícula':r.matricula,'Funcionário':r.funcionario,'Setor':r.setor,'Objeto':r.objeto,'Data Retirada':r.dataRet,'Data Devolução':r.dataDev}));
  const ws = XLSX.utils.json_to_sheet(rows), wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Relatório');
  XLSX.writeFile(wb, 'Relatorio_KnifeControl.csv.xlsx');
});

qs('#btnPDF')?.addEventListener('click', ()=>{
  const data = cacheRelatorio.length ? cacheRelatorio : consolidarPares(DB.logs||[]);
  if(!data.length){ alert('Não há dados para exportar.'); return; }
  const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'pt',format:'a4'});
  const margin=40; const pageW=doc.internal.pageSize.getWidth();
  doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text('KnifeControl – Relatório de Movimentações', margin, 50);
  const logoW=120, logoH=40, logoX=pageW-margin-logoW, logoY=30; try{ if(LOGO_LSG_BASE64) doc.addImage(LOGO_LSG_BASE64,'PNG',logoX,logoY,logoW,logoH);}catch(e){console.warn('Logo LSG não inserido:',e);}
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  const filtros = [
    ['Matrícula', qs('#fMatricula').value || '—'],
    ['Funcionário', qs('#fFuncionario').value || '—'],
    ['Setor', qs('#fSetor').value || '—'],
    ['Objeto', qs('#fObjeto').value || '—'],
    ['Data Retirada', qs('#fDataRet').value || '—'],
    ['Data Devolução', qs('#fDataDev').value || '—']
  ].map(([k,v])=>`${k}: ${v}`).join('   •   ');
  doc.text(filtros, margin, 70, {maxWidth: pageW - margin*2 - 10});
  const rows = data.map(r=>[r.matricula||'', r.funcionario||'', r.setor||'', r.objeto||'', r.dataRet||'', r.dataDev||'']);
  doc.autoTable({ startY:86, head:[['Matrícula','Funcionário','Setor','Objeto','Retirada','Devolução']], body:rows, styles:{fontSize:9,cellPadding:6}, headStyles:{fillColor:[37,99,235],textColor:255}, theme:'grid', margin:{left:margin,right:margin} });
  const pc = doc.internal.getNumberOfPages();
  for(let i=1;i<=pc;i++){
    doc.setPage(i); doc.setFontSize(9); doc.setTextColor(80);
    const h = doc.internal.pageSize.getHeight();
    doc.text('Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG', margin, h-45);
    doc.text('CNPJ 33.375.601/0001-38', margin, h-33);
    doc.text('Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro – Ilha do Governador – RJ', margin, h-21, {maxWidth: pageW - margin*2});
    doc.setTextColor(120); const txt=`Emitido em ${new Date().toLocaleString('pt-BR')} • Página ${i}/${pc}`; doc.text(txt, margin, h-8);
  }
  doc.save('Relatorio_KnifeControl.pdf');
});
</script>

<script>
// =================== PARTE 5/5 – Movimentações + Salvar ===================
qs('#btnRetirada')?.addEventListener('click', ()=>{
  const matricula = qs('#mvFuncionario').value; const emp = (DB.funcionarios||[]).find(f=>f.matricula===matricula);
  const setor = qs('#mvSetor').value; const objeto = qs('#mvObjeto').value; const device = (qs('#mvDevice').value.trim() || detectarDevice());
  if(!emp){ alert('Funcionário inválido.'); return; }
  if(!objeto){ alert('Selecione um objeto.'); return; }
  DB.logs.push({ timestamp:new Date().toISOString(), acao:'RETIRADA', matricula:emp.matricula, funcionario:emp.nome, setor, objeto, device, assinatura:'' });
  markDirty(); alert('Retirada registrada com sucesso!');
});

qs('#btnDevolucao')?.addEventListener('click', ()=>{
  const matricula = qs('#mvFuncionario').value; const setor = qs('#mvSetor').value; const objeto = qs('#mvObjeto').value; const emp = (DB.funcionarios||[]).find(f=>f.matricula===matricula);
  if(!emp){ alert('Funcionário inválido.'); return; }
  const abertos = listarRetiradasAbertas();
  const existeAberta = abertos.some(a=> a.matricula===matricula && a.setor===setor && a.objeto===objeto);
  if(!existeAberta){ if(!confirm('Não encontramos retirada em aberto para esta combinação. Registrar devolução mesmo assim?')) return; }
  DB.logs.push({ timestamp:new Date().toISOString(), acao:'DEVOLUCAO', matricula:emp.matricula, funcionario:emp.nome, setor, objeto, device:(qs('#mvDevice').value.trim() || detectarDevice()), assinatura:'' });
  markDirty(); alert('Devolução registrada com sucesso!');
});

qs('#btnListarAbertos')?.addEventListener('click', ()=>{
  const lista = listarRetiradasAbertas(); const cont = qs('#abertos'); cont.innerHTML='';
  if(!lista.length){ cont.innerHTML = '<span class="chip">Nenhuma retirada em aberto</span>'; return; }
  cont.innerHTML = lista.map(l=>`<span class="chip">(${escapeHTML(l.matricula)}) ${escapeHTML(l.funcionario)} • ${escapeHTML(l.setor)} • ${escapeHTML(l.objeto)} • Retirada: ${escapeHTML(fmtDateTime(l.timestamp))}</span>`).join('');
});

function listarRetiradasAbertas(){
  const logs = (DB.logs||[]).slice().sort((a,b)=> (a.timestamp||'').localeCompare(b.timestamp||''));
  const key = x => [x.matricula,x.setor,x.objeto].join('||');
  const map = new Map();
  for(const l of logs){ const k = key(l); if(!map.has(k)) map.set(k,[]); map.get(k).push(l); }
  const out = [];
  for(const [k,list] of map){
    const used = new Set();
    list.forEach((ev,i)=>{ if(ev.acao!=='RETIRADA') return; const d = list.findIndex((x,j)=> j>i && x.acao==='DEVOLUCAO' && !used.has(j)); if(d>=0) used.add(d); else out.push(ev); });
  }
  return out;
}

qs('#btnSalvar')?.addEventListener('click', ()=>{
  const payload = encodeURIComponent(JSON.stringify(DB));
  window.open('backend.html?update='+payload, '_blank');
});

qs('#btnBaixarLocal')?.addEventListener('click', ()=>{
  const text = JSON.stringify(DB,null,2); const blob = new Blob([text],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='planilha.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
</script>

<script>
/* ===================== INTEGRAÇÃO COM SHEETS (CSV) ===================== */
async function fetchCSV(url){
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error('Falha ao baixar CSV: ' + res.status + ' ' + res.statusText);
  return await res.text();
}
function parseCSV(text){
  const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
  if(lines.length === 0) return [];
  const header = splitCSVLine(lines[0]);
  return lines.slice(1).map(line => {
    const cols = splitCSVLine(line);
    const obj = {};
    header.forEach((h,i)=> obj[h.trim()] = (cols[i] ?? '').trim());
    return obj;
  });
}
function splitCSVLine(line){
  const out = []; let cur = '', inQ = false;
  for(let i=0;i<line.length;i++){
    const c = line[i];
    if(c === '"'){
      if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
      else inQ = !inQ;
    } else if(c === ',' && !inQ){ out.push(cur); cur=''; }
    else { cur += c; }
  }
  out.push(cur); return out;
}
function buildSetorPorObjeto(){
  const idx = {};
  (DB.setores || []).forEach(set => (DB.objetos?.[set] || []).forEach(obj => { idx[obj] = set; }));
  return idx;
}
function enriquecerLogsCSV(rows){
  const setorPorObjeto = buildSetorPorObjeto();
  const funcs = DB.funcionarios || [];
  return rows.map(r => {
    const timestamp = r.timestamp || r.Timestamp || r.data || '';
    const acao      = (r.acao || r.Acao || r['ação'] || '').toUpperCase();
    const matricula = r.matricula || r.Matricula || r['Matrícula'] || '';
    const objeto    = r.objeto || r.Objeto || '';
    const setorCSV  = r.setor_login || r.Setor || '';
    const nome = funcs.find(f => f.matricula === matricula)?.nome || '';
    const setorCad = objeto ? (setorPorObjeto[objeto] || '') : '';
    const setor = setorCad || setorCSV || '';
    return {
      timestamp, acao, matricula,
      funcionario: nome, setor, objeto,
      dataRet: acao==='RETIRADA'  && timestamp ? timestamp.slice(0,10) : '',
      dataDev: acao==='DEVOLUCAO' && timestamp ? timestamp.slice(0,10) : ''
    };
  });
}
function previewAmostra(lines, limit=10){
  const amostra = lines.slice(0, limit);
  const txt = JSON.stringify(amostra, null, 2);
  qs('#csvPreview').textContent = amostra.length ? txt : 'Nenhum dado encontrado no CSV.';
}
function usarLogsCSVNaSessao(linesCSV){
  let base = linesCSV; // usar apenas os CSV enriquecidos
  cacheRelatorio = base; preencherTabela(base); renderChips(base.length);
}
qs('#btnPreviewCSV')?.addEventListener('click', async () => {
  try{
    const url = qs('#urlCSVLogs').value.trim();
    if(!url) { alert('Cole a URL pública do CSV.'); return; }
    const text = await fetchCSV(url);
    const rows = parseCSV(text);
    const enr  = enriquecerLogsCSV(rows);
    previewAmostra(enr, 10);
  } catch(e){ alert('Falha ao pré-visualizar CSV: ' + (e?.message||e)); }
});
qs('#btnUsarCSV')?.addEventListener('click', async () => {
  try{
    const url = qs('#urlCSVLogs').value.trim();
    if(!url) { alert('Cole a URL pública do CSV.'); return; }
    const text = await fetchCSV(url);
    const rows = parseCSV(text);
    const enr  = enriquecerLogsCSV(rows);
    const consolidar = qs('#chkConsolidar').checked;
    if(consolidar){
      const pares = consolidarPares(enr.map(x => ({
        timestamp:x.timestamp, acao:x.acao, matricula:x.matricula,
        funcionario:x.funcionario, setor:x.setor, objeto:x.objeto
      })));
      usarLogsCSVNaSessao(pares);
      qs('#csvPreview').textContent = `Consolidado(s): ${pares.length} ciclo(s).`;
    } else {
      usarLogsCSVNaSessao(enr);
      qs('#csvPreview').textContent = `Carregado(s): ${enr.length} registro(s).`;
    }
  } catch(e){ alert('Falha ao usar CSV: ' + (e?.message||e)); }
});
</script>

</body>
</html>
